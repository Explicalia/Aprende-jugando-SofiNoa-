<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Sof√≠a y Noa - Aprende Jugando</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
  --color-primary: #6366f1;
  --color-primary-dark: #4f46e5;
  --color-secondary: #f97316;
  --color-accent: #10b981;
  --color-warning: #fbbf24;
  --color-error: #ef4444;
  --color-success: #22c55e;
  --color-pink: #ec4899;
  --color-bg: #faf5ff;
  --color-surface: #ffffff;
  --color-text: #1e1b4b;
  --color-text-secondary: #475569;
  --glass-bg: rgba(255,255,255,0.9);
  --glass-border: rgba(255,255,255,0.7);
  --font-family: 'Nunito', sans-serif;
  --radius-lg: 16px;
  --radius-xl: 20px;
  --radius-2xl: 24px;
  --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
  --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
  --barca-blue: #004D98;
  --barca-red: #A50044;
  --barca-blue-light: #3d7dc7;
  --barca-red-light: #d4335a;
  --explicalia-black: #0a0a0a;
  --explicalia-gold: #D4AF37;
  --spring-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html { height: 100%; }
body {
  font-family: var(--font-family);
  font-weight: 600;
  background: var(--color-bg);
  color: var(--color-text);
  line-height: 1.5;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
  min-height: 100%;
  overflow-x: hidden;
}

/* INTRO VIDEO */
#intro-screen {
  position: fixed;
  inset: 0;
  z-index: 2000;
  background: #000;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  touch-action: manipulation;
}
#intro-screen.hidden { display: none; }
#intro-video { width: 100%; height: 100%; object-fit: cover; }
.intro-fallback {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 20px;
  color: white;
  text-align: center;
  padding: 40px;
}
.intro-fallback-logo {
  font-size: 4rem;
  animation: logoFloat 3s ease-in-out infinite;
}
@keyframes logoFloat {
  0%, 100% { transform: translateY(0) scale(1); }
  50% { transform: translateY(-15px) scale(1.05); }
}
.intro-fallback-title {
  font-size: 2rem;
  font-weight: 900;
  background: linear-gradient(90deg, var(--barca-blue), var(--barca-red));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.intro-fallback-subtitle {
  font-size: 1rem;
  opacity: 0.8;
}
.intro-tap-hint {
  position: absolute;
  bottom: 15%;
  left: 50%;
  transform: translateX(-50%);
  color: white;
  font-size: 1rem;
  font-weight: 600;
  background: rgba(0,0,0,0.5);
  padding: 12px 24px;
  border-radius: 30px;
  animation: pulse 2s ease-in-out infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 0.7; transform: translateX(-50%) scale(1); }
  50% { opacity: 1; transform: translateX(-50%) scale(1.05); }
}

.bg-layer {
  position: fixed;
  inset: 0;
  z-index: 0;
  background:
    radial-gradient(ellipse at 10% 0%, rgba(0,77,152,0.12) 0%, transparent 50%),
    radial-gradient(ellipse at 90% 100%, rgba(165,0,68,0.1) 0%, transparent 50%),
    var(--color-bg);
}

/* SCREENS */
.screen {
  position: relative;
  min-height: 100vh;
  min-height: 100dvh;
  display: none;
  flex-direction: column;
  align-items: center;
  z-index: 10;
  padding: 16px;
  padding-bottom: 32px;
  overflow-y: auto;
  overflow-x: hidden;
  scroll-behavior: smooth;
  touch-action: pan-y manipulation;
}
.screen.active { display: flex; animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* BOMBILLA ELEGANTE */
.easter-egg-trigger {
  position: absolute;
  top: 12px;
  right: 12px;
  width: 44px;
  height: 44px;
  cursor: pointer;
  z-index: 100;
  display: flex;
  align-items: center;
  justify-content: center;
  background: transparent;
  border: none;
  padding: 0;
  transition: transform 0.3s var(--spring-bounce);
  touch-action: manipulation;
}
.easter-egg-trigger:hover { transform: scale(1.1); }
.easter-egg-trigger:active { transform: scale(0.9); }
.easter-egg-trigger svg { width: 32px; height: 32px; overflow: visible; }
.bulb-glass {
  fill: rgba(255, 255, 255, 0.1);
  stroke: url(#barcaGradient);
  stroke-width: 1.5;
  animation: bulbPulse 2s ease-in-out infinite;
}
.bulb-filament {
  stroke: var(--barca-red);
  stroke-width: 1.2;
  stroke-linecap: round;
  animation: filamentGlow 1.5s ease-in-out infinite;
}
.bulb-base { fill: #8a8a8a; stroke: #666; stroke-width: 0.5; }
.bulb-rays { stroke: var(--barca-blue); stroke-width: 1.5; stroke-linecap: round; opacity: 0; animation: raysAppear 2s ease-in-out infinite; }
.bulb-glow { fill: url(#glowGradient); opacity: 0; animation: glowPulse 2s ease-in-out infinite; }

@keyframes bulbPulse {
  0%, 100% { fill: rgba(0, 77, 152, 0.15); filter: drop-shadow(0 0 2px rgba(0, 77, 152, 0.3)); }
  50% { fill: rgba(165, 0, 68, 0.25); filter: drop-shadow(0 0 8px rgba(165, 0, 68, 0.5)); }
}
@keyframes filamentGlow {
  0%, 100% { stroke: var(--barca-blue); filter: drop-shadow(0 0 1px var(--barca-blue)); }
  50% { stroke: var(--barca-red); filter: drop-shadow(0 0 4px var(--barca-red)); }
}
@keyframes raysAppear {
  0%, 20% { opacity: 0; transform: scale(0.8); }
  50% { opacity: 0.8; transform: scale(1); }
  80%, 100% { opacity: 0; transform: scale(1.1); }
}
@keyframes glowPulse { 0%, 100% { opacity: 0.3; } 50% { opacity: 0.7; } }

/* MUSIC BUTTON */
.music-trigger {
  position: absolute;
  top: 12px;
  right: 60px;
  width: 44px;
  height: 44px;
  cursor: pointer;
  z-index: 100;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, var(--barca-red), #ff6b9d);
  border: none;
  border-radius: 50%;
  padding: 0;
  transition: transform 0.3s var(--spring-bounce);
  touch-action: manipulation;
  box-shadow: 0 4px 15px rgba(165, 0, 68, 0.4);
}
.music-trigger:hover { transform: scale(1.1); }
.music-trigger:active { transform: scale(0.9); }
.music-trigger.playing { animation: musicPulse 1s ease-in-out infinite; }
.music-trigger svg { width: 22px; height: 22px; fill: white; }
@keyframes musicPulse {
  0%, 100% { transform: scale(1); box-shadow: 0 4px 15px rgba(165, 0, 68, 0.4); }
  50% { transform: scale(1.08); box-shadow: 0 6px 25px rgba(165, 0, 68, 0.6); }
}

/* WELCOME */
#welcome { justify-content: center; gap: 20px; text-align: center; position: relative; }
.welcome-mascot { font-size: 4rem; animation: bounce 2s ease-in-out infinite; }
@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
.welcome-title { font-size: clamp(1.5rem, 6vw, 2rem); font-weight: 900; text-align: center; width: 100%; }
.welcome-subtitle { font-size: 1rem; color: var(--color-text-secondary); max-width: 300px; text-align: center; }
.welcome-form { width: 100%; max-width: 320px; display: flex; flex-direction: column; gap: 14px; align-items: center; }
.name-input {
  width: 100%;
  padding: 16px;
  font-size: 1.1rem;
  font-family: var(--font-family);
  font-weight: 700;
  text-align: center;
  border: 2px solid transparent;
  border-radius: var(--radius-2xl);
  background: var(--color-surface);
  box-shadow: var(--shadow-md);
  transition: all 0.2s;
}
.name-input:focus { outline: none; border-color: var(--color-primary); transform: scale(1.02); }

.avatar-select {
  padding: 14px;
  background: var(--glass-bg);
  border-radius: var(--radius-2xl);
  border: 2px solid var(--glass-border);
  width: 100%;
}
.avatar-select-label { font-size: 0.9rem; color: var(--color-text-secondary); margin-bottom: 8px; text-align: center; }
.avatar-options { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
.avatar-option {
  width: 52px;
  height: 52px;
  border: 3px solid transparent;
  border-radius: var(--radius-xl);
  cursor: pointer;
  transition: all 0.3s var(--spring-bounce);
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--color-surface);
  touch-action: manipulation;
  flex-shrink: 0;
}
.avatar-option.selected { border-color: var(--color-primary); transform: scale(1.15); }
.avatar-option img { width: 36px; height: 36px; }

.start-btn {
  width: 100%;
  padding: 16px 24px;
  font-size: 1.1rem;
  font-family: var(--font-family);
  font-weight: 800;
  text-align: center;
  color: white;
  background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
  border: none;
  border-radius: var(--radius-2xl);
  cursor: pointer;
  box-shadow: 0 4px 16px rgba(99,102,241,0.4);
  min-height: 56px;
  display: flex;
  align-items: center;
  justify-content: center;
  touch-action: manipulation;
  flex-shrink: 0;
  transition: all 0.2s var(--spring-bounce);
}
.start-btn:hover { transform: translateY(-3px) scale(1.02); }
.start-btn:active { transform: translateY(0) scale(0.98); }

/* MENU */
#menu { gap: 14px; position: relative; }
.menu-header { text-align: center; margin-bottom: 4px; padding-top: 8px; }
.greeting { font-size: 0.85rem; font-weight: 700; color: var(--color-primary); text-transform: uppercase; letter-spacing: 0.1em; }
.menu-title { font-size: clamp(1.2rem, 5vw, 1.7rem); font-weight: 900; text-align: center; }
.player-avatar {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  margin-top: 10px;
  padding: 12px 16px;
  background: linear-gradient(135deg, rgba(0,77,152,0.1) 0%, rgba(165,0,68,0.1) 100%);
  border-radius: var(--radius-2xl);
}
.avatar-mascot {
  width: 50px;
  height: 50px;
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.8rem;
  box-shadow: 0 4px 12px rgba(251,191,36,0.35);
  border: 3px solid white;
  flex-shrink: 0;
  transition: transform 0.3s var(--spring-bounce);
}
.avatar-mascot:hover { transform: scale(1.1) rotate(5deg); }
.player-stats { text-align: center; }
.player-name { font-size: 1.1rem; font-weight: 900; }
.player-level { font-size: 0.8rem; color: var(--color-primary); font-weight: 700; }
.player-stars { font-size: 0.8rem; color: var(--color-warning); }

.progress-overview {
  width: 100%;
  max-width: 360px;
  padding: 14px;
  background: var(--glass-bg);
  border-radius: var(--radius-2xl);
  border: 2px solid var(--glass-border);
  flex-shrink: 0;
}
.progress-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
.progress-title { font-size: 0.85rem; color: var(--color-text-secondary); }
.progress-value { font-size: 0.9rem; font-weight: 800; color: var(--color-primary); }
.progress-bar-bg { height: 8px; background: #e5e7eb; border-radius: 10px; overflow: hidden; }
.progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--barca-blue), var(--barca-red)); border-radius: 10px; transition: width 0.5s var(--spring-bounce); }

.games-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; max-width: 360px; }
.game-card {
  padding: 14px;
  background: var(--glass-bg);
  border-radius: var(--radius-2xl);
  border: 2px solid var(--glass-border);
  cursor: pointer;
  transition: all 0.3s var(--spring-bounce);
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  touch-action: manipulation;
  flex-shrink: 0;
}
.game-card:hover { transform: translateY(-4px) scale(1.03); box-shadow: var(--shadow-lg); }
.game-card:active { transform: translateY(0) scale(0.97); }
.game-icon { font-size: 2rem; margin-bottom: 6px; transition: transform 0.3s var(--spring-bounce); }
.game-card:hover .game-icon { transform: scale(1.2); }
.game-title { font-size: 0.95rem; font-weight: 800; text-align: center; width: 100%; display: flex; align-items: center; justify-content: center; line-height: 1.2; }
.game-levels { display: flex; justify-content: center; gap: 4px; margin-top: 6px; }
.level-dot { width: 7px; height: 7px; border-radius: 50%; background: #e5e7eb; transition: all 0.3s; }
.level-dot.completed { background: var(--color-success); transform: scale(1.2); }
.level-dot.current { background: var(--color-warning); animation: dotPulse 1.5s ease-in-out infinite; }
@keyframes dotPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.3); } }

.language-selector {
  padding: 12px;
  background: var(--glass-bg);
  border-radius: var(--radius-2xl);
  border: 2px solid var(--glass-border);
  text-align: center;
  max-width: 360px;
  width: 100%;
  flex-shrink: 0;
}
.language-label { font-size: 0.8rem; color: var(--color-text-secondary); margin-bottom: 6px; }
.language-buttons { display: flex; justify-content: center; gap: 6px; flex-wrap: wrap; }
.lang-btn {
  padding: 8px 14px;
  font-size: 0.8rem;
  font-family: var(--font-family);
  font-weight: 700;
  border: 2px solid var(--glass-border);
  border-radius: var(--radius-lg);
  background: var(--color-surface);
  cursor: pointer;
  transition: all 0.2s var(--spring-bounce);
  display: flex;
  align-items: center;
  justify-content: center;
  touch-action: manipulation;
}
.lang-btn:hover { transform: scale(1.05); }
.lang-btn:active { transform: scale(0.95); }
.lang-btn.active { background: var(--barca-blue); color: white; border-color: var(--barca-blue); }
.settings-row { display: flex; gap: 8px; margin-top: 6px; justify-content: center; flex-wrap: wrap; }
.settings-btn {
  padding: 10px 16px;
  font-size: 0.85rem;
  font-family: var(--font-family);
  font-weight: 700;
  border: 2px solid var(--glass-border);
  border-radius: var(--radius-xl);
  background: var(--color-surface);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  touch-action: manipulation;
  transition: all 0.2s var(--spring-bounce);
}
.settings-btn:hover { transform: scale(1.03); }
.settings-btn:active { transform: scale(0.97); }

/* GAME SELECT */
#game-select { gap: 14px; position: relative; }
.game-select-header { text-align: center; padding-top: 8px; }
.game-select-icon { font-size: 3rem; margin-bottom: 6px; }
.game-select-title { font-size: 1.3rem; font-weight: 900; text-align: center; }
.levels-grid { display: flex; flex-direction: column; gap: 8px; width: 100%; max-width: 360px; }
.level-card {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px;
  background: var(--glass-bg);
  border-radius: var(--radius-2xl);
  border: 2px solid var(--glass-border);
  cursor: pointer;
  min-height: 56px;
  touch-action: manipulation;
  flex-shrink: 0;
  transition: all 0.25s var(--spring-bounce);
}
.level-card:hover { transform: scale(1.02) translateX(4px); }
.level-card:active { transform: scale(0.98); }
.level-card.locked { opacity: 0.5; cursor: not-allowed; }
.level-number {
  width: 40px;
  height: 40px;
  border-radius: var(--radius-lg);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 900;
  font-size: 1rem;
  background: #e5e7eb;
  flex-shrink: 0;
  transition: all 0.3s;
}
.level-card.completed .level-number { background: var(--color-success); color: white; transform: scale(1.1); }
.level-card.current .level-number { background: var(--color-warning); color: white; animation: levelPulse 1.5s ease-in-out infinite; }
@keyframes levelPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
.level-info { flex: 1; min-width: 0; }
.level-name { font-size: 0.95rem; font-weight: 800; }
.level-desc { font-size: 0.75rem; color: var(--color-text-secondary); }
.back-btn {
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.3rem;
  background: var(--glass-bg);
  border: 2px solid var(--glass-border);
  border-radius: var(--radius-lg);
  cursor: pointer;
  touch-action: manipulation;
  flex-shrink: 0;
  transition: all 0.2s var(--spring-bounce);
}
.back-btn:hover { transform: scale(1.1); }
.back-btn:active { transform: scale(0.9); }

/* GAME */
#game { gap: 10px; position: relative; }
.game-top-bar {
  width: 100%;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 0;
  flex-shrink: 0;
}
.menu-btn {
  padding: 10px 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
  font-size: 0.85rem;
  font-weight: 700;
  text-align: center;
  color: white;
  background: linear-gradient(135deg, var(--barca-blue), var(--barca-red));
  border: none;
  border-radius: var(--radius-lg);
  cursor: pointer;
  min-height: 44px;
  touch-action: manipulation;
  transition: all 0.2s var(--spring-bounce);
}
.menu-btn:hover { transform: scale(1.05); }
.menu-btn:active { transform: scale(0.95); }
.game-level-badge { font-size: 0.8rem; font-weight: 700; color: var(--color-text-secondary); }
.progress-stars { display: flex; gap: 3px; }
.progress-star { font-size: 1.1rem; color: #e5e7eb; transition: all 0.4s var(--spring-bounce); }
.progress-star.earned { color: var(--color-warning); animation: starPop 0.5s ease; }
@keyframes starPop { 0% { transform: scale(0) rotate(-180deg); } 50% { transform: scale(1.4) rotate(10deg); } 100% { transform: scale(1) rotate(0); } }

.game-instruction {
  width: 100%;
  max-width: 360px;
  padding: 12px;
  text-align: center;
  background: var(--glass-bg);
  border-radius: var(--radius-2xl);
  border: 2px solid var(--glass-border);
  flex-shrink: 0;
}
.instruction-text { font-size: 0.95rem; font-weight: 700; text-align: center; }
.instruction-name { color: var(--barca-blue); }

.game-area { 
  display: none; 
  flex: 1; 
  width: 100%; 
  flex-direction: column; 
  align-items: center; 
  justify-content: flex-start; 
  gap: 12px; 
  touch-action: pan-y manipulation;
  overflow-y: auto;
  padding-bottom: 20px;
}
.game-area.active { display: flex; }

/* MEMORY */
.memory-grid { display: grid; gap: 8px; padding: 8px; max-width: 380px; }
.memory-card {
  aspect-ratio: 1;
  position: relative;
  transform-style: preserve-3d;
  transition: transform 0.5s var(--spring-bounce);
  cursor: pointer;
  min-width: 55px;
  touch-action: manipulation;
}
.memory-card.flipped { transform: rotateY(180deg); }
.card-face {
  position: absolute;
  inset: 0;
  backface-visibility: hidden;
  border-radius: var(--radius-xl);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2.2rem;
  background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
  border: 3px solid var(--barca-blue);
}
.card-front::after { content: '?'; font-size: 1.3rem; font-weight: 800; color: var(--barca-blue); }
.card-back { transform: rotateY(180deg); background: var(--color-surface); border-color: var(--color-accent); }
.memory-card.matched .card-back { background: #fef3c7; border-color: var(--color-warning); animation: matchPop 0.4s ease; }
@keyframes matchPop { 0%, 100% { transform: rotateY(180deg) scale(1); } 50% { transform: rotateY(180deg) scale(1.1); } }

/* NUMBERS */
.numbers-container { display: flex; flex-direction: column; align-items: center; gap: 14px; max-width: 360px; width: 100%; }
.number-intro-card {
  padding: 20px;
  background: var(--glass-bg);
  border-radius: var(--radius-2xl);
  border: 2px solid var(--glass-border);
  text-align: center;
  cursor: pointer;
  touch-action: manipulation;
  width: 100%;
  transition: all 0.2s var(--spring-bounce);
}
.number-intro-card:hover { transform: scale(1.02); }
.number-intro-card:active { transform: scale(0.98); }
.number-big { font-size: 4.5rem; font-weight: 900; color: var(--barca-blue); }
.number-objects { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 10px; }
.number-object { font-size: 2.2rem; animation: objectBounce 0.5s ease backwards; }
@keyframes objectBounce { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.counting-objects { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; padding: 16px; background: var(--glass-bg); border-radius: var(--radius-2xl); }
.counting-item { 
  font-size: 2.2rem; 
  padding: 8px; 
  border-radius: var(--radius-lg); 
  cursor: pointer; 
  touch-action: manipulation;
  transition: all 0.2s var(--spring-bounce);
}
.counting-item.touched { 
  background: #dcfce7; 
  transform: scale(1.2) rotate(5deg);
}
.count-option {
  width: 56px;
  height: 56px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  font-weight: 900;
  background: var(--color-surface);
  border: 3px solid var(--glass-border);
  border-radius: var(--radius-xl);
  cursor: pointer;
  touch-action: manipulation;
  transition: all 0.2s var(--spring-bounce);
}
.count-option:hover { transform: scale(1.1); }
.count-option:active { transform: scale(0.9); }
.count-option.correct { background: #dcfce7; border-color: var(--color-success); animation: correctPop 0.4s ease; }
@keyframes correctPop { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
.count-option.wrong { animation: shake 0.4s; border-color: var(--color-error); }
@keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }

/* SOFIA */
.sofia-container { display: flex; flex-direction: column; align-items: center; gap: 12px; max-width: 360px; width: 100%; }
.sofia-plane { font-size: 3rem; animation: fly 3s ease-in-out infinite; }
@keyframes fly { 0%, 100% { transform: translateX(-15px) rotate(-8deg); } 50% { transform: translateX(15px) rotate(8deg); } }
.sofia-country-card { text-align: center; padding: 16px; background: var(--glass-bg); border-radius: var(--radius-2xl); border: 2px solid var(--glass-border); width: 100%; }
.sofia-flag { font-size: 3.5rem; }
.sofia-country-name { font-size: 1.2rem; font-weight: 900; margin: 6px 0; }
.sofia-options { width: 100%; display: flex; flex-direction: column; gap: 8px; }
.capital-btn {
  width: 100%;
  padding: 14px 12px;
  font-size: 1rem;
  font-family: var(--font-family);
  font-weight: 800;
  text-align: center;
  background: var(--glass-bg);
  border: 3px solid var(--glass-border);
  border-radius: var(--radius-2xl);
  cursor: pointer;
  touch-action: manipulation;
  flex-shrink: 0;
  min-height: 52px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s var(--spring-bounce);
}
.capital-btn:hover { transform: scale(1.03); }
.capital-btn:active { transform: scale(0.97); }
.capital-btn.correct { background: #dcfce7; border-color: var(--color-success); }
.capital-btn.wrong { background: #fef2f2; border-color: var(--color-error); }

/* COLORS */
.colors-container { display: flex; flex-direction: column; align-items: center; gap: 14px; max-width: 360px; width: 100%; }
.color-target {
  text-align: center;
  padding: 20px;
  background: var(--glass-bg);
  border-radius: var(--radius-2xl);
  width: 100%;
  position: relative;
  overflow: hidden;
}
.target-emoji { 
  font-size: 4.5rem; 
  display: block;
  margin-bottom: 8px;
  animation: emojiFloat 3s ease-in-out infinite;
}
@keyframes emojiFloat { 
  0%, 100% { transform: translateY(0) rotate(-2deg); } 
  50% { transform: translateY(-8px) rotate(2deg); } 
}
.target-question { font-size: 1.1rem; margin-top: 8px; text-align: center; font-weight: 700; }
.target-word { font-weight: 900; color: var(--barca-blue); }
.target-hint {
  font-size: 0.85rem;
  color: var(--color-text-secondary);
  margin-top: 8px;
  opacity: 0;
  animation: fadeInHint 0.5s ease 1s forwards;
}
@keyframes fadeInHint { to { opacity: 1; } }
.color-palette { 
  display: flex; 
  flex-wrap: wrap; 
  justify-content: center; 
  gap: 12px; 
  padding: 16px;
}
.color-btn {
  width: 58px;
  height: 58px;
  border-radius: var(--radius-2xl);
  border: 4px solid white;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  touch-action: manipulation;
  transition: all 0.25s var(--spring-bounce);
  position: relative;
}
.color-btn::after {
  content: '';
  position: absolute;
  inset: -4px;
  border-radius: calc(var(--radius-2xl) + 4px);
  border: 3px solid transparent;
  transition: all 0.2s;
}
.color-btn:hover { transform: scale(1.15) translateY(-4px); }
.color-btn:active { transform: scale(0.9); }
.color-btn.selected::after { border-color: var(--color-success); }
.color-btn.correct { 
  animation: colorCorrect 0.5s ease;
  box-shadow: 0 0 30px rgba(34, 197, 94, 0.6);
}
@keyframes colorCorrect {
  0% { transform: scale(1); }
  30% { transform: scale(1.3); }
  60% { transform: scale(0.9); }
  100% { transform: scale(1); }
}
.color-btn.wrong { 
  animation: colorWrong 0.4s ease;
  box-shadow: 0 0 20px rgba(239, 68, 68, 0.6);
}
@keyframes colorWrong {
  0%, 100% { transform: translateX(0); }
  20% { transform: translateX(-10px); }
  40% { transform: translateX(10px); }
  60% { transform: translateX(-5px); }
  80% { transform: translateX(5px); }
}

/* MUSIC GAME */
.music-container { display: flex; flex-direction: column; align-items: center; gap: 12px; max-width: 360px; width: 100%; }
.music-header {
  text-align: center;
  padding: 16px;
  background: var(--glass-bg);
  border-radius: var(--radius-2xl);
  width: 100%;
}
.music-level-title { font-size: 1.1rem; font-weight: 800; color: var(--barca-blue); }
.music-instruction { font-size: 0.9rem; color: var(--color-text-secondary); margin-top: 4px; }
.music-round-info {
  font-size: 0.85rem;
  font-weight: 700;
  color: var(--barca-red);
  margin-top: 4px;
}
.music-sequence {
  display: flex;
  justify-content: center;
  gap: 8px;
  padding: 16px;
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
  border-radius: var(--radius-2xl);
  min-height: 80px;
  align-items: center;
  flex-wrap: wrap;
}
.sequence-note {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.3rem;
  font-weight: 900;
  color: white;
  opacity: 0.4;
  transition: all 0.3s var(--spring-bounce);
}
.sequence-note.active {
  opacity: 1;
  transform: scale(1.3);
  box-shadow: 0 0 20px currentColor;
}
.sequence-note.played { opacity: 1; transform: scale(1.1); }
.piano-container {
  display: flex;
  justify-content: center;
  gap: 6px;
  padding: 20px 16px;
  background: linear-gradient(180deg, #2d2d2d 0%, #1a1a1a 100%);
  border-radius: var(--radius-2xl);
  width: 100%;
}
.piano-key {
  width: 42px;
  height: 120px;
  background: linear-gradient(180deg, #fff 0%, #e8e8e8 100%);
  border-radius: 0 0 8px 8px;
  border: 2px solid #ccc;
  cursor: pointer;
  touch-action: manipulation;
  position: relative;
  transition: all 0.1s;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-end;
  padding-bottom: 8px;
}
.piano-key:active {
  background: linear-gradient(180deg, #ddd 0%, #ccc 100%);
  transform: translateY(3px);
}
.piano-key.pressed {
  background: linear-gradient(180deg, #fff9c4 0%, #ffd54f 100%);
  box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
  transform: translateY(2px);
}
.piano-key .note-label {
  font-size: 0.75rem;
  font-weight: 800;
  color: #666;
}
.piano-key.correct {
  background: linear-gradient(180deg, #a5d6a7 0%, #66bb6a 100%);
  box-shadow: 0 0 25px rgba(76, 175, 80, 0.6);
}
.piano-key.wrong {
  background: linear-gradient(180deg, #ef9a9a 0%, #e57373 100%);
  animation: shake 0.3s;
}
.music-progress {
  display: flex;
  justify-content: center;
  gap: 6px;
  margin-top: 8px;
}
.music-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: #e5e7eb;
  transition: all 0.3s var(--spring-bounce);
}
.music-dot.completed { background: var(--color-success); transform: scale(1.2); }
.music-dot.current { background: var(--color-warning); animation: dotPulse 1s ease-in-out infinite; }

/* VOCAB POPUP */
.vocab-popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--color-surface);
  padding: 20px 28px;
  border-radius: var(--radius-2xl);
  text-align: center;
  box-shadow: var(--shadow-lg);
  z-index: 100;
  display: none;
}
.vocab-popup.show { display: block; animation: popIn 0.4s var(--spring-bounce); }
@keyframes popIn { from { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
.vocab-emoji { font-size: 3rem; }
.vocab-word { font-size: 1.2rem; font-weight: 800; color: var(--barca-blue); }
.vocab-translation { font-size: 1rem; color: var(--color-accent); font-weight: 700; }

/* LEVEL COMPLETE */
#level-complete { justify-content: center; gap: 16px; text-align: center; position: relative; }
.complete-mascot { font-size: 3.5rem; animation: mascotBounce 0.6s ease; }
@keyframes mascotBounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
.complete-title { font-size: clamp(1.4rem, 6vw, 1.9rem); font-weight: 900; text-align: center; animation: titlePop 0.5s ease; }
@keyframes titlePop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.complete-subtitle { font-size: 0.95rem; color: var(--color-text-secondary); text-align: center; }
.complete-stars { display: flex; justify-content: center; gap: 10px; }
.complete-star { font-size: 2.2rem; color: #e5e7eb; }
.complete-star.earned { color: var(--color-warning); animation: starBounce 0.5s ease backwards; }
@keyframes starBounce { 0% { transform: scale(0) rotate(-180deg); } 60% { transform: scale(1.3) rotate(10deg); } 100% { transform: scale(1) rotate(0); } }
.words-learned { max-width: 320px; }
.words-title { font-size: 0.85rem; color: var(--color-text-secondary); margin-bottom: 10px; text-align: center; }
.words-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; }
.word-chip {
  padding: 8px;
  background: var(--glass-bg);
  border-radius: var(--radius-xl);
  text-align: center;
  cursor: pointer;
  transition: all 0.2s var(--spring-bounce);
}
.word-chip:hover { transform: scale(1.1); }
.word-chip:active { transform: scale(0.95); }
.word-emoji { font-size: 1.6rem; }
.word-es { font-size: 0.7rem; font-weight: 800; color: var(--barca-blue); }
.word-en { font-size: 0.65rem; color: var(--color-accent); }
.complete-actions { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; max-width: 260px; align-items: center; }
.complete-btn {
  width: 100%;
  padding: 14px 20px;
  font-size: 0.95rem;
  font-family: var(--font-family);
  font-weight: 800;
  text-align: center;
  border: none;
  border-radius: var(--radius-2xl);
  cursor: pointer;
  min-height: 54px;
  display: flex;
  align-items: center;
  justify-content: center;
  touch-action: manipulation;
  flex-shrink: 0;
  transition: all 0.2s var(--spring-bounce);
}
.complete-btn:hover { transform: scale(1.03); }
.complete-btn:active { transform: scale(0.97); }
.complete-btn.primary { background: linear-gradient(135deg, var(--barca-blue), var(--barca-red)); color: white; box-shadow: 0 4px 16px rgba(0,77,152,0.3); }
.complete-btn.secondary { background: var(--glass-bg); border: 2px solid var(--glass-border); }

/* CONFETTI */
.confetti-container { position: fixed; inset: 0; pointer-events: none; z-index: 200; overflow: hidden; }
.confetti { position: absolute; width: 10px; height: 10px; top: -10px; animation: fall linear forwards; }
@keyframes fall { to { transform: translateY(100vh) rotate(720deg); opacity: 0; } }

/* EASTER EGG OVERLAY */
.easter-egg-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.92);
  z-index: 1000;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 16px;
  touch-action: manipulation;
  overflow-y: auto;
}
.easter-egg-overlay.active { display: flex; }
.easter-egg-card {
  background: linear-gradient(145deg, #0f0f0f 0%, #1a1a1a 100%);
  border: 2px solid var(--explicalia-gold);
  border-radius: 20px;
  width: 100%;
  max-width: 340px;
  padding: 22px 18px;
  text-align: center;
  flex-shrink: 0;
  animation: cardSlide 0.4s var(--spring-bounce);
}
@keyframes cardSlide { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.explicalia-brand { font-size: 1.2rem; font-weight: 800; background: linear-gradient(90deg, var(--explicalia-gold), #f5d77e); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.explicalia-subtitle { font-size: 0.75rem; color: #6B7280; margin-top: 4px; }
.explicalia-divider { width: 50%; height: 1px; background: linear-gradient(90deg, transparent, var(--explicalia-gold), transparent); margin: 14px auto; }
.easter-egg-title { font-size: 0.95rem; font-weight: 700; color: #fff; margin-bottom: 16px; }
.easter-egg-progress { font-size: 0.7rem; color: #4B5563; margin-bottom: 6px; }
.easter-egg-question { font-size: 0.95rem; font-weight: 600; color: #fff; margin-bottom: 12px; }
.easter-egg-options { display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px; }
.easter-egg-option {
  background: #1A1A1A;
  border: 2px solid #333;
  border-radius: 12px;
  padding: 10px 14px;
  font-size: 0.9rem;
  font-weight: 600;
  color: #fff;
  cursor: pointer;
  transition: all 0.2s;
  touch-action: manipulation;
}
.easter-egg-option:hover { border-color: var(--explicalia-gold); transform: scale(1.02); }
.easter-egg-option.correct { background: rgba(212, 175, 55, 0.2); border-color: var(--explicalia-gold); }
.easter-egg-option.wrong { background: rgba(165,0,68,0.2); border-color: var(--barca-red); }
.easter-egg-btn {
  background: linear-gradient(135deg, var(--explicalia-gold), #c9a227);
  color: #0a0a0a;
  border: none;
  border-radius: 12px;
  padding: 10px 20px;
  font-size: 0.9rem;
  font-weight: 700;
  cursor: pointer;
  touch-action: manipulation;
  transition: all 0.2s var(--spring-bounce);
}
.easter-egg-btn:hover { transform: scale(1.05); }
.deco-bar { display: flex; height: 5px; border-radius: 3px; overflow: hidden; margin-top: 14px; }
.deco-bar span { flex: 1; }
.barca-blue-bar { background: var(--barca-blue); }
.barca-red-bar { background: var(--barca-red); }

/* EXPLICALIA SUCCESS */
.explicalia-success-icon {
  font-size: 2.8rem;
  margin-bottom: 10px;
  animation: successPop 0.5s ease;
}
@keyframes successPop {
  0% { transform: scale(0); }
  50% { transform: scale(1.2); }
  100% { transform: scale(1); }
}
.explicalia-success-title {
  font-size: 1rem;
  font-weight: 700;
  background: linear-gradient(90deg, var(--explicalia-gold), #f5d77e); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  margin-bottom: 6px;
}
.explicalia-success-message {
  font-size: 0.9rem;
  color: #fff;
  margin-bottom: 14px;
  line-height: 1.5;
}

/* SONG MODAL */
.song-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  z-index: 1500;
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  padding: 20px;
}
.song-modal.active { display: flex; }
.song-modal video {
  max-width: 100%;
  max-height: 70vh;
  border-radius: var(--radius-2xl);
}
.song-close {
  margin-top: 16px;
  padding: 12px 24px;
  background: var(--barca-red);
  color: white;
  border: none;
  border-radius: var(--radius-xl);
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s var(--spring-bounce);
}
.song-close:hover { transform: scale(1.05); }

/* RESPONSIVE */
@media (max-width: 360px) {
  .memory-card { min-width: 50px; }
  .game-card { padding: 12px; }
  .game-title { font-size: 0.9rem; }
  .capital-btn { padding: 12px 10px; font-size: 0.95rem; min-height: 48px; }
  .count-option { width: 50px; height: 50px; font-size: 1.4rem; }
  .number-big { font-size: 3.5rem; }
  .sofia-flag { font-size: 3rem; }
  .complete-btn { padding: 12px 16px; min-height: 50px; }
  .color-btn { width: 52px; height: 52px; }
  .piano-key { width: 38px; height: 100px; }
}
@media (min-width: 768px) {
  .games-grid { grid-template-columns: repeat(3, 1fr); max-width: 500px; }
  .game-card { min-height: 130px; }
  .complete-btn { min-height: 58px; font-size: 1rem; }
  .capital-btn { padding: 16px; font-size: 1.05rem; }
}
@media (pointer: coarse) {
  .game-card, .level-card, .complete-btn, .menu-btn, .start-btn, .lang-btn, .settings-btn, .back-btn, .capital-btn {
    min-height: 50px;
  }
  .memory-card { min-width: 65px; }
  .count-option { width: 60px; height: 60px; }
  .color-btn { width: 60px; height: 60px; }
  .avatar-option { width: 56px; height: 56px; }
}
</style>
</head>
<body>

<!-- INTRO VIDEO -->
<div id="intro-screen" onclick="skipIntro()">
  <video id="intro-video" autoplay muted playsinline onended="skipIntro()" onerror="showIntroFallback()">
    <source src="intro.MP4" type="video/mp4">
  </video>
  <div class="intro-fallback" id="introFallback" style="display:none;">
    <div class="intro-fallback-logo">üåü</div>
    <div class="intro-fallback-title">Sof√≠a y Noa</div>
    <div class="intro-fallback-subtitle">Aprende Jugando</div>
  </div>
  <div class="intro-tap-hint" id="introHint">Toca para comenzar</div>
</div>

<!-- SONG MODAL -->
<div class="song-modal" id="songModal">
  <video id="songVideo" controls>
    <source src="gemini_generated_video_6CE8FA43.mp4" type="video/mp4">
  </video>
  <button class="song-close" onclick="closeSongModal()">Cerrar</button>
</div>

<div class="bg-layer"></div>

<!-- WELCOME SCREEN -->
<div id="welcome" class="screen active">
  <button class="easter-egg-trigger" onclick="openEasterEgg()" aria-label="Preguntas para adultos">
    <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="barcaGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#004D98"/>
          <stop offset="100%" style="stop-color:#A50044"/>
        </linearGradient>
        <radialGradient id="glowGradient" cx="50%" cy="40%" r="50%">
          <stop offset="0%" style="stop-color:rgba(255,255,255,0.8)"/>
          <stop offset="100%" style="stop-color:rgba(255,255,255,0)"/>
        </radialGradient>
        <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
          <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
        </filter>
      </defs>
      <g class="bulb-rays-group">
        <line class="bulb-rays" x1="20" y1="3" x2="20" y2="0"/>
        <line class="bulb-rays" x1="30" y1="6" x2="32" y2="3"/>
        <line class="bulb-rays" x1="10" y1="6" x2="8" y2="3"/>
        <line class="bulb-rays" x1="34" y1="14" x2="37" y2="12"/>
        <line class="bulb-rays" x1="6" y1="14" x2="3" y2="12"/>
      </g>
      <path class="bulb-glass" d="M20 6 C12 6 8 12 8 18 C8 22 10 26 14 29 L14 32 L26 32 L26 29 C30 26 32 22 32 18 C32 12 28 6 20 6 Z" filter="url(#glow)"/>
      <ellipse class="bulb-glow" cx="20" cy="16" rx="6" ry="5"/>
      <g class="filament-group">
        <path class="bulb-filament" d="M16 28 Q16 22 18 20 Q20 18 20 22 Q20 18 22 20 Q24 22 24 28"/>
      </g>
      <rect class="bulb-base" x="15" y="32" width="10" height="3" rx="1"/>
      <rect class="bulb-base" x="16" y="35" width="8" height="2" rx="1"/>
      <rect class="bulb-base" x="17" y="37" width="6" height="2" rx="1"/>
    </svg>
  </button>
  
  <button class="music-trigger" id="musicBtn" onclick="toggleSong()" aria-label="La canci√≥n de Sof√≠a y Noa" title="La canci√≥n de Sof√≠a y Noa">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
    </svg>
  </button>
  
  <div class="welcome-mascot">üåü</div>
  <h1 class="welcome-title">¬°Hola, peque√±o/a!</h1>
  <p class="welcome-subtitle">¬øC√≥mo te llamas? Tu pap√° o mam√° puede escribir tu nombre</p>
  <form class="welcome-form" onsubmit="return startGame(event)">
    <input type="text" class="name-input" id="playerNameInput" placeholder="Tu nombre..." maxlength="12" required>
    <div class="avatar-select">
      <div class="avatar-select-label">Elige tu mascota:</div>
      <div class="avatar-options">
        <div class="avatar-option selected" data-avatar="teddy" onclick="selectAvatar('teddy')">
          <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f9f8.svg" alt="oso">
        </div>
        <div class="avatar-option" data-avatar="bunny" onclick="selectAvatar('bunny')">
          <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f430.svg" alt="conejo">
        </div>
        <div class="avatar-option" data-avatar="fox" onclick="selectAvatar('fox')">
          <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f98a.svg" alt="zorro">
        </div>
        <div class="avatar-option" data-avatar="cat" onclick="selectAvatar('cat')">
          <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f408.svg" alt="gato">
        </div>
      </div>
    </div>
    <button type="submit" class="start-btn">Comenzar aventura</button>
  </form>
</div>

<!-- MENU SCREEN -->
<div id="menu" class="screen">
  <button class="easter-egg-trigger" onclick="openEasterEgg()" aria-label="Preguntas para adultos">
    <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="barcaGradient2" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#004D98"/>
          <stop offset="100%" style="stop-color:#A50044"/>
        </linearGradient>
      </defs>
      <g class="bulb-rays-group">
        <line class="bulb-rays" x1="20" y1="3" x2="20" y2="0"/>
        <line class="bulb-rays" x1="30" y1="6" x2="32" y2="3"/>
        <line class="bulb-rays" x1="10" y1="6" x2="8" y2="3"/>
      </g>
      <path class="bulb-glass" d="M20 6 C12 6 8 12 8 18 C8 22 10 26 14 29 L14 32 L26 32 L26 29 C30 26 32 22 32 18 C32 12 28 6 20 6 Z"/>
      <ellipse class="bulb-glow" cx="20" cy="16" rx="6" ry="5"/>
      <g class="filament-group">
        <path class="bulb-filament" d="M16 28 Q16 22 18 20 Q20 18 20 22 Q20 18 22 20 Q24 22 24 28"/>
      </g>
      <rect class="bulb-base" x="15" y="32" width="10" height="3" rx="1"/>
      <rect class="bulb-base" x="16" y="35" width="8" height="2" rx="1"/>
      <rect class="bulb-base" x="17" y="37" width="6" height="2" rx="1"/>
    </svg>
  </button>
  
  <button class="music-trigger" id="musicBtn2" onclick="toggleSong()" aria-label="La canci√≥n de Sof√≠a y Noa" title="La canci√≥n de Sof√≠a y Noa">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
    </svg>
  </button>
  
  <div class="menu-header">
    <div class="greeting">Bienvenido/a de nuevo</div>
    <h1 class="menu-title">¬øQu√© quieres aprender hoy?</h1>
    <div class="player-avatar">
      <div class="avatar-mascot" id="menuMascot">üß∏</div>
      <div class="player-stats">
        <div class="player-name" id="playerNameDisplay">Sof√≠a</div>
        <div class="player-level" id="playerLevelDisplay">Nivel 1</div>
        <div class="player-stars" id="playerStarsDisplay">‚≠ê 0</div>
      </div>
    </div>
  </div>
  <div class="progress-overview">
    <div class="progress-header">
      <span class="progress-title">Progreso total</span>
      <span class="progress-value" id="totalProgress">0%</span>
    </div>
    <div class="progress-bar-bg">
      <div class="progress-bar-fill" id="progressFill" style="width: 0%"></div>
    </div>
  </div>
  <div class="games-grid">
    <div class="game-card" onclick="openGameSelect('zoo')">
      <div class="game-icon">ü¶Å</div>
      <div class="game-title">El Gran Zoo</div>
      <div class="game-levels" id="zooLevels"></div>
    </div>
    <div class="game-card" onclick="openGameSelect('numbers')">
      <div class="game-icon">üî¢</div>
      <div class="game-title">N√∫meros</div>
      <div class="game-levels" id="numbersLevels"></div>
    </div>
    <div class="game-card" onclick="openGameSelect('sofia')">
      <div class="game-icon">‚úàÔ∏è</div>
      <div class="game-title">El Mundo de Sof√≠a</div>
      <div class="game-levels" id="sofiaLevels"></div>
    </div>
    <div class="game-card" onclick="openGameSelect('colors')">
      <div class="game-icon">üé®</div>
      <div class="game-title">Los colores de Noa</div>
      <div class="game-levels" id="colorsLevels"></div>
    </div>
    <div class="game-card" onclick="openGameSelect('music')">
      <div class="game-icon">üéπ</div>
      <div class="game-title">La M√∫sica de Noa</div>
      <div class="game-levels" id="musicLevels"></div>
    </div>
  </div>
  <div class="language-selector">
    <div class="language-label">Idioma / Language:</div>
    <div class="language-buttons">
      <button class="lang-btn active" onclick="setLanguage('es')">üá™üá∏ ES</button>
      <button class="lang-btn" onclick="setLanguage('en')">üá¨üáß EN</button>
      <button class="lang-btn" onclick="setLanguage('ro')">üá∑üá¥ RO</button>
    </div>
  </div>
  <div class="settings-row">
    <button class="settings-btn" onclick="changeName()">Cambiar nombre</button>
    <button class="settings-btn" onclick="resetProgress()">Reiniciar</button>
  </div>
</div>

<!-- GAME SELECT -->
<div id="game-select" class="screen">
  <div class="game-select-header">
    <div class="game-select-icon" id="gameSelectIcon">ü¶Å</div>
    <h1 class="game-select-title" id="gameSelectTitle">El Gran Zoo</h1>
  </div>
  <div class="levels-grid" id="levelsGrid"></div>
  <button class="back-btn" onclick="goToMenu()" style="margin-top: 12px;">‚Üê</button>
</div>

<!-- GAME -->
<div id="game" class="screen">
  <div class="game-top-bar">
    <button class="back-btn" onclick="exitGame()">‚Üê</button>
    <button class="menu-btn" onclick="goToMenu()">üè† Men√∫</button>
    <div class="game-level-badge" id="levelBadge">Nivel 1</div>
    <div class="progress-stars" id="progressStars"></div>
  </div>
  <div class="game-instruction">
    <p class="instruction-text"><span id="instructionPlayerName">Sof√≠a</span>, <span id="instructionText">¬°Encuentra las parejas!</span></p>
  </div>
  <div class="game-area" id="memoryArea"><div class="memory-grid" id="memoryGrid"></div></div>
  <div class="game-area" id="numbersArea"><div class="numbers-container" id="numbersContainer"></div></div>
  <div class="game-area" id="sofiaArea"><div class="sofia-container" id="sofiaContainer"></div></div>
  <div class="game-area" id="colorsArea"><div class="colors-container" id="colorsContainer"></div></div>
  <div class="game-area" id="musicArea"><div class="music-container" id="musicContainer"></div></div>
</div>

<!-- VOCAB POPUP -->
<div class="vocab-popup" id="vocabPopup">
  <div class="vocab-emoji" id="vocabEmoji"></div>
  <div class="vocab-word" id="vocabWord"></div>
  <div class="vocab-translation" id="vocabTranslation"></div>
</div>

<!-- LEVEL COMPLETE -->
<div id="level-complete" class="screen">
  <div class="complete-mascot" id="completeMascot">üß∏</div>
  <h1 class="complete-title" id="completeTitle">¬°Lo lograste!</h1>
  <p class="complete-subtitle" id="completeSubtitle">Completaste el nivel</p>
  <div class="complete-stars" id="completeStars"></div>
  <div class="words-learned">
    <div class="words-title">üìö Palabras aprendidas</div>
    <div class="words-grid" id="wordsGrid"></div>
  </div>
  <div class="complete-actions">
    <button class="complete-btn primary" onclick="nextLevel()">Siguiente nivel</button>
    <button class="complete-btn secondary" onclick="goToMenu()">Volver al men√∫</button>
  </div>
</div>

<!-- CONFETTI -->
<div class="confetti-container" id="confettiContainer"></div>

<!-- EASTER EGG -->
<div class="easter-egg-overlay" id="easterEggOverlay" onclick="closeEasterEgg(event)">
  <div class="easter-egg-card" id="easterEggCard" onclick="event.stopPropagation()"></div>
</div>

<script>
// === DEVICE DETECTION ===
const isTablet = /(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(navigator.userAgent) || (window.innerWidth >= 768 && 'ontouchstart' in window);
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
if(isTablet) document.body.classList.add('tablet-device');

// === INTRO VIDEO ===
function skipIntro() {
  document.getElementById('intro-screen').classList.add('hidden');
  localStorage.setItem('introSeen', 'true');
  initAudio();
}
function showIntroFallback() {
  document.getElementById('intro-video').style.display = 'none';
  document.getElementById('introFallback').style.display = 'flex';
}
function handleVideoError() {
  showIntroFallback();
}
if (localStorage.getItem('introSeen') === 'true') {
  document.getElementById('intro-screen').classList.add('hidden');
}

// === SONG VIDEO ===
function toggleSong() {
  const modal = document.getElementById('songModal');
  const video = document.getElementById('songVideo');
  const btn1 = document.getElementById('musicBtn');
  const btn2 = document.getElementById('musicBtn2');
  
  modal.classList.add('active');
  video.play();
  if(btn1) btn1.classList.add('playing');
  if(btn2) btn2.classList.add('playing');
  
  playSound('tap');
}
function closeSongModal() {
  const modal = document.getElementById('songModal');
  const video = document.getElementById('songVideo');
  const btn1 = document.getElementById('musicBtn');
  const btn2 = document.getElementById('musicBtn2');
  
  video.pause();
  video.currentTime = 0;
  modal.classList.remove('active');
  if(btn1) btn1.classList.remove('playing');
  if(btn2) btn2.classList.remove('playing');
}

// === DATA ===
const ANIMALS = [
  {emoji:"ü¶Å",es:"LE√ìN",en:"Lion"},{emoji:"üêØ",es:"TIGRE",en:"Tiger"},{emoji:"üêò",es:"ELEFANTE",en:"Elephant"},
  {emoji:"ü¶í",es:"JIRAFA",en:"Giraffe"},{emoji:"ü¶ì",es:"CEBRA",en:"Zebra"},{emoji:"üêí",es:"MONO",en:"Monkey"},
  {emoji:"üêÆ",es:"VACA",en:"Cow"},{emoji:"üê∑",es:"CERDO",en:"Pig"},{emoji:"üêî",es:"GALLINA",en:"Chicken"},
  {emoji:"üê¥",es:"CABALLO",en:"Horse"},{emoji:"üê∂",es:"PERRO",en:"Dog"},{emoji:"üê±",es:"GATO",en:"Cat"},
  {emoji:"üê∞",es:"CONEJO",en:"Rabbit"},{emoji:"ü¶ä",es:"ZORRO",en:"Fox"},{emoji:"üêª",es:"OSO",en:"Bear"},
  {emoji:"üêº",es:"PANDA",en:"Panda"},{emoji:"üê®",es:"KOALA",en:"Koala"},{emoji:"ü¶ò",es:"CANGURO",en:"Kangaroo"},
  {emoji:"üê¢",es:"TORTUGA",en:"Turtle"},{emoji:"üê∏",es:"RANA",en:"Frog"},{emoji:"üêß",es:"PING√úINO",en:"Penguin"},
  {emoji:"ü¶Ñ",es:"UNICORNIO",en:"Unicorn"},{emoji:"ü¶â",es:"B√öHO",en:"Owl"},{emoji:"ü¶ã",es:"MARIPOSA",en:"Butterfly"}
];
const NUMBERS = [
  {num:1,es:"UNO",en:"One"},{num:2,es:"DOS",en:"Two"},{num:3,es:"TRES",en:"Three"},
  {num:4,es:"CUATRO",en:"Four"},{num:5,es:"CINCO",en:"Five"},{num:6,es:"SEIS",en:"Six"},
  {num:7,es:"SIETE",en:"Seven"},{num:8,es:"OCHO",en:"Eight"},{num:9,es:"NUEVE",en:"Nine"},{num:10,es:"DIEZ",en:"Ten"}
];
const COUNT_OBJS = ["üçé","üåü","üéà","ü¶ã","üå∏","üç™","‚öΩ","üé®","üìö","üéÅ","üöó","üêï","üå∫","üçä","üíé"];
const COUNTRIES = [
  {flag:"üá™üá∏",country:"Espa√±a",capital:"Madrid",capitalEn:"Madrid"},
  {flag:"üá∑üá¥",country:"Ruman√≠a",capital:"Bucarest",capitalEn:"Bucharest"},
  {flag:"üá´üá∑",country:"Francia",capital:"Par√≠s",capitalEn:"Paris"},
  {flag:"üáÆüáπ",country:"Italia",capital:"Roma",capitalEn:"Rome"},
  {flag:"üá¨üáß",country:"Reino Unido",capital:"Londres",capitalEn:"London"},
  {flag:"üá©üá™",country:"Alemania",capital:"Berl√≠n",capitalEn:"Berlin"},
  {flag:"üáµüáπ",country:"Portugal",capital:"Lisboa",capitalEn:"Lisbon"},
  {flag:"üá≥üá±",country:"Pa√≠ses Bajos",capital:"√Åmsterdam",capitalEn:"Amsterdam"},
  {flag:"üáµüá±",country:"Polonia",capital:"Varsovia",capitalEn:"Warsaw"},
  {flag:"üá∫üá∏",country:"Estados Unidos",capital:"Washington",capitalEn:"Washington"},
  {flag:"üá≤üáΩ",country:"M√©xico",capital:"Ciudad de M√©xico",capitalEn:"Mexico City"},
  {flag:"üá¶üá∑",country:"Argentina",capital:"Buenos Aires",capitalEn:"Buenos Aires"},
  {flag:"üáßüá∑",country:"Brasil",capital:"Brasilia",capitalEn:"Brasilia"},
  {flag:"üáØüáµ",country:"Jap√≥n",capital:"Tokio",capitalEn:"Tokyo"}
];
const COLORS_OBJ = [
  {emoji:"üçé",color:"rojo",colorEn:"Red",hex:"#ef4444"},
  {emoji:"üçå",color:"amarillo",colorEn:"Yellow",hex:"#fbbf24"},
  {emoji:"ü•í",color:"verde",colorEn:"Green",hex:"#22c55e"},
  {emoji:"ü´ê",color:"azul",colorEn:"Blue",hex:"#3b82f6"},
  {emoji:"üß°",color:"naranja",colorEn:"Orange",hex:"#f97316"},
  {emoji:"üçá",color:"morado",colorEn:"Purple",hex:"#a855f7"},
  {emoji:"üå∏",color:"rosa",colorEn:"Pink",hex:"#ec4899"},
  {emoji:"‚òÅÔ∏è",color:"blanco",colorEn:"White",hex:"#f8fafc"}
];
const COLORS_PAL = [
  {name:"ROJO",en:"Red",hex:"#ef4444"},{name:"AMARILLO",en:"Yellow",hex:"#fbbf24"},
  {name:"VERDE",en:"Green",hex:"#22c55e"},{name:"AZUL",en:"Blue",hex:"#3b82f6"},
  {name:"NARANJA",en:"Orange",hex:"#f97316"},{name:"MORADO",en:"Purple",hex:"#a855f7"},
  {name:"ROSA",en:"Pink",hex:"#ec4899"},{name:"BLANCO",en:"White",hex:"#f8fafc"}
];

// MUSIC GAME DATA - Piano notes
const PIANO_NOTES = [
  {note: 'C', freq: 261.63, color: '#ef4444', label: 'Do'},
  {note: 'D', freq: 293.66, color: '#f97316', label: 'Re'},
  {note: 'E', freq: 329.63, color: '#fbbf24', label: 'Mi'},
  {note: 'F', freq: 349.23, color: '#22c55e', label: 'Fa'},
  {note: 'G', freq: 392.00, color: '#3b82f6', label: 'Sol'},
  {note: 'A', freq: 440.00, color: '#a855f7', label: 'La'},
  {note: 'B', freq: 493.88, color: '#ec4899', label: 'Si'}
];

// Song patterns for Simon Says mode (each level has different starting notes)
const SONG_PATTERNS = {
  // Level 2: Start with 2 notes, add 1 each round
  martillo: ['C', 'D', 'E', 'C', 'D', 'E', 'F', 'E'],
  // Level 3: Start with 2 notes
  twinkle: ['C', 'C', 'G', 'G', 'A', 'A', 'G', 'F'],
  // Level 4: Start with 2 notes
  happy: ['G', 'G', 'A', 'G', 'C', 'B', 'A', 'G'],
  // Level 5: Himno Bar√ßa - Start with 2 notes
  barca: ['C', 'E', 'G', 'C', 'E', 'G', 'A', 'G', 'F', 'E', 'D', 'C']
};

const LEVELS = {
  zoo:[{pairs:3,rounds:3},{pairs:4,rounds:4},{pairs:6,rounds:6},{pairs:4,rounds:4},{pairs:8,rounds:8}],
  numbers:[{type:"intro",nums:[1,2,3],rounds:3},{type:"count",max:3,rounds:4},{type:"select",max:5,rounds:5},{type:"order",seq:[1,2,3,4,5],rounds:5},{type:"select",max:10,rounds:6}],
  sofia:[{count:2,rounds:2},{count:3,rounds:3},{count:5,rounds:5},{count:7,rounds:7},{count:10,rounds:10}],
  colors:[{colors:["rojo","amarillo","verde","azul"],rounds:4},{colors:["rojo","amarillo","verde","azul","naranja","morado"],rounds:5},{colors:null,rounds:6},{colors:null,rounds:6},{colors:null,rounds:8}],
  music:[{type:"free",rounds:5},{type:"simon",song:"martillo",rounds:6},{type:"simon",song:"twinkle",rounds:6},{type:"simon",song:"happy",rounds:6},{type:"simon",song:"barca",rounds:8}]
};
const AVATARS = {teddy:"https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f9f8.svg",bunny:"https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f430.svg",fox:"https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f98a.svg",cat:"https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f408.svg"};

// === STATE ===
let lang='es',playerName='',avatar='teddy',game='',level=0,progress={},score=0,totalRounds=0,learned=[],flipped=[],locked=false,numIdx=0,countAns=0,countTouched=[],sofiaData=[],sofiaIdx=0,colorItem=null,eeStep=0;
let musicSequence = [], musicUserSequence = [], musicNoteIndex = 0, musicPhase = 'idle', musicRound = 0, musicMaxNotes = 2;

// === EASTER EGG ===
function openEasterEgg(){eeStep=0;renderEE();document.getElementById('easterEggOverlay').classList.add('active');}
function closeEasterEgg(e){if(e&&e.target!==e.currentTarget)return;document.getElementById('easterEggOverlay').classList.remove('active');}
function renderEE(){
  const c=document.getElementById('easterEggCard');
  if(eeStep===0)c.innerHTML='<div class="explicalia-brand">www.explicalia.com</div><div class="explicalia-subtitle">Creador del juego</div><div class="explicalia-divider"></div><div class="easter-egg-title">Preguntas importantes para poder jugar üòéüòá</div><button class="easter-egg-btn" onclick="eeStep=1;renderEE()">CONTINUAR ‚Üí</button><div class="deco-bar"><span class="barca-blue-bar"></span><span class="barca-red-bar"></span></div>';
  else if(eeStep===1)c.innerHTML='<div class="explicalia-brand">www.explicalia.com</div><div class="explicalia-divider"></div><div class="easter-egg-progress">PREGUNTA 1 de 2</div><div class="easter-egg-question">¬øQui√©n es el mejor jugador de la historia del f√∫tbol?</div><div class="easter-egg-options"><div class="easter-egg-option" onclick="answerEE(1,\'A\')">A) Messi üá¶üá∑</div><div class="easter-egg-option" onclick="answerEE(1,\'B\')">B) Iniesta üá™üá∏</div><div class="easter-egg-option" onclick="answerEE(1,\'C\')">C) Xavi üá™üá∏</div></div><div class="deco-bar"><span class="barca-blue-bar"></span><span class="barca-red-bar"></span></div>';
  else if(eeStep===2)c.innerHTML='<div class="explicalia-brand">www.explicalia.com</div><div class="explicalia-divider"></div><div class="easter-egg-progress">PREGUNTA 2 de 2</div><div class="easter-egg-question">¬øQui√©n es el mejor piloto de motos del mundo?</div><div class="easter-egg-options"><div class="easter-egg-option" onclick="answerEE(2,\'A\')">A) Marc M.</div><div class="easter-egg-option" onclick="answerEE(2,\'B\')">B) M. M√°rquez</div><div class="easter-egg-option" onclick="answerEE(2,\'C\')">C) Marc M√°rquez</div></div><div class="deco-bar"><span class="barca-blue-bar"></span><span class="barca-red-bar"></span></div>';
  else if(eeStep===3)c.innerHTML='<div class="explicalia-brand">EXPLICALIA SYSTEM</div><div class="explicalia-divider"></div><div class="explicalia-success-icon">üèÜ</div><div class="explicalia-success-title">¬°FELICIDADES!</div><div class="explicalia-success-message">Has demostrado saber lo m√°s importante:<br><strong>MESSI</strong> es el mejor jugador de la historia<br>y <strong>MARC M√ÅRQUEZ</strong> el mejor piloto de motos.<br><br>¬°Ya puedes jugar!</div><button class="easter-egg-btn" onclick="closeEasterEgg({target:{}})">COMENZAR JUEGO</button><div class="deco-bar"><span class="barca-blue-bar"></span><span class="barca-red-bar"></span></div>';
}
function answerEE(q,a){
  const opts=document.querySelectorAll('.easter-egg-option');
  if(q===1){
    if(a==='A'){
      // Correct answer - Apple style feedback
      opts[0].classList.add('correct');
      playSound('success');
      setTimeout(()=>{eeStep=2;renderEE();},1000);
    }else{
      // Wrong answer - show correct after delay
      const wrongIdx = a==='B'?1:2;
      opts[wrongIdx].classList.add('wrong');
      playSound('wrong');
      setTimeout(()=>{opts[0].classList.add('correct');playSound('correct');},400);
      setTimeout(()=>{eeStep=2;renderEE();},1500);
    }
  }else{
    if(a==='C'){
      // Correct answer - Apple style feedback
      opts[2].classList.add('correct');
      playSound('success');
      setTimeout(()=>{eeStep=3;renderEE();},1000);
    }else{
      // Wrong answer - show correct after delay
      const wrongIdx = a==='A'?0:1;
      opts[wrongIdx].classList.add('wrong');
      playSound('wrong');
      setTimeout(()=>{opts[2].classList.add('correct');playSound('correct');},400);
      setTimeout(()=>{eeStep=3;renderEE();},1500);
    }
  }
}

// === NAV ===
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');window.scrollTo(0,0);}
function startGame(e){e.preventDefault();const n=document.getElementById('playerNameInput').value.trim();if(n.length<2)return false;playerName=n.charAt(0).toUpperCase()+n.slice(1).toLowerCase();saveProg();initMenu();showScreen('menu');playSound('success');return false;}
function initMenu(){document.getElementById('playerNameDisplay').textContent=playerName;document.getElementById('menuMascot').innerHTML='<img src="'+AVATARS[avatar]+'" style="width:40px;height:40px;">';updateProg();updateDots();}
function goToMenu(){playSound('tap');showScreen('menu');updateProg();updateDots();}
function changeName(){playSound('tap');document.getElementById('playerNameInput').value='';showScreen('welcome');}

// === PROGRESS ===
function loadProg(){const s=localStorage.getItem('progV12');if(s){const d=JSON.parse(s);progress=d.progress||{};playerName=d.name||'';avatar=d.avatar||'teddy';}if(!progress.zoo)progress.zoo=[];if(!progress.numbers)progress.numbers=[];if(!progress.sofia)progress.sofia=[];if(!progress.colors)progress.colors=[];if(!progress.music)progress.music=[];const l=localStorage.getItem('lang');if(l)lang=l;document.querySelectorAll('.avatar-option').forEach(o=>o.classList.toggle('selected',o.dataset.avatar===avatar));}
function saveProg(){localStorage.setItem('progV12',JSON.stringify({name:playerName,avatar:avatar,progress:progress}));}
function updateProg(){let t=0,c=0;Object.keys(LEVELS).forEach(g=>{t+=LEVELS[g].length;c+=progress[g]?progress[g].length:0;});const p=t>0?Math.round((c/t)*100):0;document.getElementById('totalProgress').textContent=p+'%';document.getElementById('progressFill').style.width=p+'%';const lvl=c<5?'Principiante':c<10?'Explorador':c<15?'Aventurero':'Maestro';document.getElementById('playerLevelDisplay').textContent=lvl;document.getElementById('playerStarsDisplay').textContent='‚≠ê '+c;}
function updateDots(){Object.keys(LEVELS).forEach(g=>{const c=document.getElementById(g+'Levels');if(!c)return;c.innerHTML='';const l=LEVELS[g].length,d=progress[g]?progress[g].length:0;for(let i=0;i<l;i++){const dot=document.createElement('div');dot.className='level-dot';if(i<d)dot.classList.add('completed');else if(i===d)dot.classList.add('current');c.appendChild(dot);}});}
function resetProgress(){if(confirm('¬øBorrar todo el progreso?')){progress={zoo:[],numbers:[],sofia:[],colors:[],music:[]};saveProg();updateProg();updateDots();playSound('tap');}}

// === LANG ===
function setLanguage(l){lang=l;localStorage.setItem('lang',l);document.querySelectorAll('.lang-btn').forEach((b,i)=>b.classList.toggle('active',(l==='es'&&i===0)||(l==='en'&&i===1)||(l==='ro'&&i===2)));}

// === AVATAR ===
function selectAvatar(a){avatar=a;document.querySelectorAll('.avatar-option').forEach(o=>o.classList.toggle('selected',o.dataset.avatar===a));playSound('tap');}

// === AUDIO SYSTEM ===
let audioCtx = null;
let audioInitialized = false;
let audioVolume = isMobile ? 0.06 : 0.1;
const soundBuffers = {};

function initAudio(){
  if(audioInitialized) return;
  try{
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if(audioCtx.state === 'suspended') audioCtx.resume();
    audioInitialized = true;
    preloadSounds();
  }catch(e){ console.log('Audio no disponible'); }
}

function preloadSounds(){
  if(!audioCtx) return;
  soundBuffers.tap = () => playOscillator(600, 0.08);
  soundBuffers.success = () => playChord([523, 659, 783], 0.2);
  soundBuffers.correct = () => playChord([523, 659], 0.15);
  soundBuffers.wrong = () => playOscillator(200, 0.15, 'sawtooth');
  soundBuffers.pop = () => playOscillator(800, 0.05);
}

function playOscillator(freq, duration, type = 'sine'){
  if(!audioCtx || audioCtx.state === 'suspended') audioCtx?.resume();
  if(!audioCtx) return;
  const ct = audioCtx.currentTime;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  o.type = type;
  o.frequency.setValueAtTime(freq, ct);
  g.gain.setValueAtTime(audioVolume, ct);
  g.gain.linearRampToValueAtTime(0, ct + duration);
  o.start(ct); o.stop(ct + duration);
}

function playChord(freqs, duration){
  if(!audioCtx || audioCtx.state === 'suspended') audioCtx?.resume();
  if(!audioCtx) return;
  const ct = audioCtx.currentTime;
  freqs.forEach((f, i) => {
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    o.frequency.value = f;
    g.gain.setValueAtTime(audioVolume * 0.6, ct + i * 0.08);
    g.gain.linearRampToValueAtTime(0, ct + i * 0.08 + duration);
    o.start(ct + i * 0.08); o.stop(ct + i * 0.08 + duration);
  });
}

function playPianoNote(freq){
  if(!audioCtx || audioCtx.state === 'suspended') audioCtx?.resume();
  if(!audioCtx) return;
  const ct = audioCtx.currentTime;
  const o = audioCtx.createOscillator();
  const o2 = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.connect(g); o2.connect(g); g.connect(audioCtx.destination);
  o.type = 'sine'; o2.type = 'triangle';
  o.frequency.setValueAtTime(freq, ct);
  o2.frequency.setValueAtTime(freq * 2, ct);
  g.gain.setValueAtTime(audioVolume * 1.2, ct);
  g.gain.exponentialRampToValueAtTime(0.001, ct + 0.8);
  o.start(ct); o2.start(ct);
  o.stop(ct + 0.8); o2.stop(ct + 0.8);
}

function playSound(t){
  if(!audioInitialized) initAudio();
  if(soundBuffers[t]) soundBuffers[t]();
  else playOscillator(500, 0.1);
  if(navigator.vibrate) navigator.vibrate(t === 'success' ? [30, 20, 30] : 15);
}

function speak(w, l='en-US'){
  if(!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(w);
  u.lang = l;
  u.rate = 0.85;
  u.pitch = 1.1;
  u.volume = isMobile ? 0.8 : 1;
  window.speechSynthesis.speak(u);
}

document.addEventListener('touchstart', initAudio, {once:true});
document.addEventListener('click', initAudio, {once:true});

// === GAME SELECT ===
function openGameSelect(g){
  playSound('tap');
  game = g;
  const icons = {zoo:'ü¶Å',numbers:'üî¢',sofia:'‚úàÔ∏è',colors:'üé®',music:'üéπ'};
  const titles = {zoo:'El Gran Zoo',numbers:'N√∫meros',sofia:'El Mundo de Sof√≠a',colors:'Los colores de Noa',music:'La M√∫sica de Noa'};
  document.getElementById('gameSelectIcon').textContent = icons[g];
  document.getElementById('gameSelectTitle').textContent = titles[g];
  renderLevels();
  showScreen('game-select');
}

function renderLevels(){
  const c = document.getElementById('levelsGrid');
  c.innerHTML = '';
  const names = {
    zoo:['Memoria F√°cil','Memoria Media','Memoria Dif√≠cil','Sonidos del Zoo','Safari Completo'],
    numbers:['Conoce los N√∫meros','Contemos Juntos','¬øCu√°ntos Hay?','Ordena los N√∫meros','Cuenta hasta 10'],
    sofia:['Espa√±a y Ruman√≠a','M√°s Pa√≠ses','Por Europa','El Mundo','Viaje Global'],
    colors:['Colores B√°sicos','M√°s Colores','Rosa y Blanco','Todos los Colores','Maestro de Colores'],
    music:['Piano Libre','Simon: Martillo','Simon: Twinkle','Simon: Happy','Himno Bar√ßa']
  };
  const descs = {
    zoo:['3 parejas','4 parejas','6 parejas','M√°s animales','Reto m√°ximo'],
    numbers:['1 al 3','Toca y cuenta','Adivina','Pon en orden','Hasta 10'],
    sofia:['2 pa√≠ses','3 pa√≠ses','5 pa√≠ses','7 pa√≠ses','Todos'],
    colors:['Principales','M√°s colores','Nuevos','Todos','Reto final'],
    music:['¬°Toca libre!','A√±ade notas','A√±ade notas','A√±ade notas','Himno Bar√ßa']
  };
  const comp = progress[game] ? progress[game].length : 0;
  for(let i = 0; i < 5; i++){
    const card = document.createElement('div');
    card.className = 'level-card';
    if(i < comp) card.classList.add('completed');
    else if(i === comp) card.classList.add('current');
    else card.classList.add('locked');
    card.innerHTML = '<div class="level-number">'+(i < comp ? '‚úì' : i+1)+'</div><div class="level-info"><div class="level-name">'+names[game][i]+'</div><div class="level-desc">'+descs[game][i]+'</div></div><div class="level-status">'+(i < comp ? '‚≠ê' : i === comp ? '‚ñ∂' : 'üîí')+'</div>';
    if(i <= comp) card.onclick = () => startLevel(i);
    c.appendChild(card);
  }
}

// === GAME ===
function startLevel(l){
  playSound('tap');
  level = l;
  score = 0;
  learned = [];
  flipped = [];
  locked = false;
  numIdx = 0;
  musicSequence = [];
  musicUserSequence = [];
  musicNoteIndex = 0;
  musicPhase = 'idle';
  musicRound = 0;
  musicMaxNotes = 2;
  document.getElementById('levelBadge').textContent = 'Nivel '+(l+1);
  document.getElementById('instructionPlayerName').textContent = playerName;
  document.querySelectorAll('.game-area').forEach(a => a.classList.remove('active'));
  totalRounds = LEVELS[game][level].rounds;
  initStars();
  showScreen('game');
  
  setTimeout(() => {
    if(game === 'zoo') startMemory();
    else if(game === 'numbers') startNumbers();
    else if(game === 'sofia') startSofia();
    else if(game === 'colors') startColors();
    else if(game === 'music') startMusic();
  }, 200);
}

function initStars(){
  const c = document.getElementById('progressStars');
  c.innerHTML = '';
  for(let i = 0; i < totalRounds; i++){
    const s = document.createElement('div');
    s.className = 'progress-star';
    s.textContent = '‚≠ê';
    c.appendChild(s);
  }
}

function addStar(){
  const stars = document.querySelectorAll('#progressStars .progress-star');
  if(stars[score]) {
    stars[score].classList.add('earned');
    playSound('correct');
  }
  score++;
  if(score >= totalRounds) setTimeout(completeLevel, 600);
}

// === MEMORY ===
function startMemory(){
  document.getElementById('memoryArea').classList.add('active');
  document.getElementById('instructionText').textContent = '¬°Encuentra las parejas!';
  const p = LEVELS.zoo[level].pairs;
  const grid = document.getElementById('memoryGrid');
  grid.innerHTML = '';
  grid.style.gridTemplateColumns = 'repeat('+(p <= 3 ? 3 : 4)+',1fr)';
  const animals = [...ANIMALS].sort(() => Math.random() - 0.5).slice(0, p);
  const cards = [...animals, ...animals].sort(() => Math.random() - 0.5);
  cards.forEach((a, idx) => {
    const card = document.createElement('div');
    card.className = 'memory-card';
    card.dataset.emoji = a.emoji;
    card.dataset.en = a.en;
    card.dataset.es = a.es;
    card.style.animationDelay = (idx * 0.05) + 's';
    card.innerHTML = '<div class="card-face card-front"></div><div class="card-face card-back">'+a.emoji+'</div>';
    card.onclick = () => flipCard(card);
    grid.appendChild(card);
  });
}

function flipCard(c){
  if(locked || c.classList.contains('flipped') || c.classList.contains('matched')) return;
  c.classList.add('flipped');
  playSound('pop');
  flipped.push(c);
  if(flipped.length === 2){ locked = true; checkMatch(); }
}

function checkMatch(){
  const [a,b] = flipped;
  if(a.dataset.emoji === b.dataset.emoji){
    a.classList.add('matched');
    b.classList.add('matched');
    showVocab(a.dataset.emoji, a.dataset.es, a.dataset.en);
    learned.push({emoji:a.dataset.emoji, es:a.dataset.es, en:a.dataset.en});
    playSound('success');
    addStar();
    flipped = [];
    locked = false;
  }else{
    playSound('tap');
    setTimeout(() => {
      a.classList.remove('flipped');
      b.classList.remove('flipped');
      flipped = [];
      locked = false;
    }, 700);
  }
}

function showVocab(emoji, es, en){
  const p = document.getElementById('vocabPopup');
  document.getElementById('vocabEmoji').textContent = emoji;
  document.getElementById('vocabWord').textContent = es;
  document.getElementById('vocabTranslation').textContent = en;
  p.classList.add('show');
  speak(en);
  setTimeout(() => p.classList.remove('show'), 1800);
}

// === NUMBERS ===
function startNumbers(){
  document.getElementById('numbersArea').classList.add('active');
  document.getElementById('instructionText').textContent = '¬°Aprende los n√∫meros!';
  const cfg = LEVELS.numbers[level];
  if(cfg.type === 'intro') runNumIntro(cfg.nums);
  else if(cfg.type === 'count') runNumCount(cfg.max);
  else if(cfg.type === 'select') runNumSelect(cfg.max);
  else runNumOrder(cfg.seq);
}

function runNumIntro(nums){
  const n = nums[numIdx];
  const nd = NUMBERS.find(x => x.num === n);
  const c = document.getElementById('numbersContainer');
  c.innerHTML = '<div class="number-intro-card" onclick="nextNumIntro()"><div class="number-big">'+n+'</div><div class="number-objects">'+Array(n).fill(0).map((_, i) => '<span class="number-object" style="animation-delay:'+(i*0.1)+'s">'+COUNT_OBJS[Math.floor(Math.random()*COUNT_OBJS.length)]+'</span>').join('')+'</div><div style="font-size:0.9rem;color:var(--color-text-secondary);margin-top:10px">¬°Toca para continuar!</div></div>';
  speak(nd.en);
  learned.push({emoji:n.toString(), es:nd.es, en:nd.en});
  addStar();
}

function nextNumIntro(){playSound('tap');numIdx++;if(numIdx < LEVELS.numbers[level].nums.length) runNumIntro(LEVELS.numbers[level].nums);else completeLevel();}

function runNumCount(max){
  countAns = Math.floor(Math.random() * max) + 1;
  countTouched = [];
  const obj = COUNT_OBJS[Math.floor(Math.random() * COUNT_OBJS.length)];
  const c = document.getElementById('numbersContainer');
  c.innerHTML = '<p style="font-size:1rem;margin-bottom:10px;text-align:center">¬°Toca cada objeto mientras cuentas!</p><div class="counting-objects">'+Array(countAns).fill(0).map((_,i) => '<span class="counting-item" onclick="touchCountItem(this,'+i+')">'+obj+'</span>').join('')+'</div><p style="font-size:1rem;margin:12px 0;text-align:center">¬øCu√°ntos hay?</p><div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">'+[countAns, Math.max(1,countAns-1), Math.min(max,countAns+1), Math.min(max,countAns+2)].sort(() => Math.random()-0.5).map(n => '<div class="count-option" onclick="checkNumCount('+n+',this)">'+n+'</div>').join('')+'</div>';
}

function touchCountItem(el, idx){
  if(!countTouched.includes(idx)){
    countTouched.push(idx);
    el.classList.add('touched');
    playSound('pop');
    speak((countTouched.length).toString());
  }
}

function checkNumCount(n, el){
  if(n === countAns){
    el.classList.add('correct');
    playSound('success');
    const nd = NUMBERS.find(x => x.num === n);
    if(nd) {
      learned.push({emoji:n.toString(), es:nd.es, en:nd.en});
      speak(nd.en);
    }
    addStar();
    setTimeout(() => runNumCount(LEVELS.numbers[level].max), 700);
  }else{
    el.classList.add('wrong');
    playSound('wrong');
    setTimeout(() => el.classList.remove('wrong'), 400);
  }
}

function runNumSelect(max){
  countAns = Math.floor(Math.random() * max) + 1;
  const obj = COUNT_OBJS[Math.floor(Math.random() * COUNT_OBJS.length)];
  const c = document.getElementById('numbersContainer');
  c.innerHTML = '<div class="counting-objects">'+Array(countAns).fill(0).map(() => '<span class="counting-item">'+obj+'</span>').join('')+'</div><p style="font-size:1rem;margin:12px 0;text-align:center">¬øCu√°ntos hay?</p><div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">'+Array.from({length:Math.min(max+2,10)},(_,i)=>i+1).sort(() => Math.random()-0.5).slice(0,4).map(n => '<div class="count-option" onclick="checkNumCount('+n+',this)">'+n+'</div>').join('')+'</div>';
}

function runNumOrder(seq){
  const c = document.getElementById('numbersContainer');
  c.innerHTML = '<p style="font-size:1rem;margin-bottom:12px;text-align:center">Pon los n√∫meros en orden:</p><div class="order-slots" id="orderSlots" style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">'+seq.map((_,i) => '<div class="order-slot" style="width:44px;height:44px;border:3px dashed #9ca3af;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;font-weight:800;color:#9ca3af" data-idx="'+i+'"></div>').join('')+'</div><div class="order-items" id="orderItems" style="margin-top:14px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">'+seq.slice().sort(() => Math.random()-0.5).map(n => '<div class="count-option" style="width:50px;height:50px;font-size:1.5rem" data-num="'+n+'" onclick="placeNum('+n+',this)">'+n+'</div>').join('')+'</div>';
}

function placeNum(n, el){
  if(el.classList.contains('used')) return;
  const slots = document.querySelectorAll('#orderSlots .order-slot');
  for(const s of slots){
    if(!s.textContent){
      s.textContent = n;
      s.style.borderStyle = 'solid';
      s.style.borderColor = 'var(--color-success)';
      s.style.background = '#dcfce7';
      s.style.color = 'var(--color-text)';
      el.classList.add('used');
      el.style.visibility = 'hidden';
      playSound('pop');
      speak(n.toString());
      break;
    }
  }
  const filled = [...slots].every(s => s.textContent);
  if(filled){
    const seq = LEVELS.numbers[level].seq;
    const correct = seq.every((n,i) => slots[i].textContent == n);
    if(correct){
      playSound('success');
      addStar();
      setTimeout(() => runNumOrder(seq), 600);
    }else{
      playSound('wrong');
      slots.forEach(s => s.style.background = '#fef2f2');
      setTimeout(() => { slots.forEach(s => s.style.background = ''); }, 400);
    }
  }
}

// === SOFIA ===
function startSofia(){
  document.getElementById('sofiaArea').classList.add('active');
  document.getElementById('instructionText').textContent = '¬°Adivina las capitales!';
  sofiaData = [...COUNTRIES].sort(() => Math.random() - 0.5).slice(0, LEVELS.sofia[level].count);
  sofiaIdx = 0;
  runSofiaQ();
}

function runSofiaQ(){
  const country = sofiaData[sofiaIdx];
  const wrongCapitals = COUNTRIES.filter(c => c.capital !== country.capital).sort(() => Math.random() - 0.5).slice(0, 2).map(c => c.capital);
  const opts = [country.capital, ...wrongCapitals].sort(() => Math.random() - 0.5);
  const c = document.getElementById('sofiaContainer');
  c.innerHTML = '<div class="sofia-plane">‚úàÔ∏è</div><div class="sofia-country-card"><div class="sofia-flag">'+country.flag+'</div><div class="sofia-country-name">'+country.country+'</div><div style="font-size:0.85rem;color:var(--color-text-secondary)">¬øCu√°l es su capital?</div></div><div class="sofia-options">'+opts.map(cap => '<button class="capital-btn" onclick="checkCapital(\''+cap+'\',\''+country.capital+'\',this,\''+country.capitalEn+'\')">'+cap+'</button>').join('')+'</div>';
  learned.push({emoji:country.flag, es:country.capital, en:country.capitalEn});
}

function checkCapital(sel, correct, el, capEn){
  if(sel === correct){
    el.classList.add('correct');
    playSound('success');
    speak(capEn);
    addStar();
    sofiaIdx++;
    if(sofiaIdx < sofiaData.length) setTimeout(runSofiaQ, 800);
  }else{
    el.classList.add('wrong');
    playSound('wrong');
    setTimeout(() => el.classList.remove('wrong'), 400);
  }
}

// === COLORS ===
function startColors(){
  document.getElementById('colorsArea').classList.add('active');
  document.getElementById('instructionText').textContent = '¬°Aprende los colores!';
  runColorQ();
}

function runColorQ(){
  const cfg = LEVELS.colors[level];
  let objs = cfg.colors ? COLORS_OBJ.filter(o => cfg.colors.includes(o.color)) : COLORS_OBJ;
  colorItem = objs[Math.floor(Math.random() * objs.length)];
  let pals = cfg.colors ? COLORS_PAL.filter(c => cfg.colors.map(x => x.toUpperCase()).includes(c.name)) : COLORS_PAL;
  const correct = COLORS_PAL.find(c => c.name === colorItem.color.toUpperCase());
  const wrong = pals.filter(c => c.name !== correct.name).sort(() => Math.random() - 0.5).slice(0, 5);
  const opts = [correct, ...wrong].sort(() => Math.random() - 0.5);
  const c = document.getElementById('colorsContainer');
  
  c.innerHTML = '<div class="color-target"><span class="target-emoji">'+colorItem.emoji+'</span><p class="target-question">¬øDe qu√© color es <span class="target-word">'+colorItem.color+'</span>?</p><p class="target-hint">Toca el color correcto üëÜ</p></div><div class="color-palette">'+opts.map(o => '<div class="color-btn" style="background:'+o.hex+'" data-name="'+o.name+'" data-en="'+o.en+'" onclick="checkColor(\''+o.name+'\',this,\''+o.en+'\')"></div>').join('')+'</div>';
  
  setTimeout(() => {
    document.querySelectorAll('.color-btn').forEach((btn, i) => {
      btn.style.opacity = '0';
      btn.style.transform = 'scale(0.5)';
      setTimeout(() => {
        btn.style.transition = 'all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)';
        btn.style.opacity = '1';
        btn.style.transform = 'scale(1)';
      }, i * 60);
    });
  }, 100);
}

function checkColor(sel, el, en){
  if(sel === colorItem.color.toUpperCase()){
    el.classList.add('correct');
    playSound('success');
    speak(en);
    learned.push({emoji:colorItem.emoji, es:colorItem.color, en:en});
    addStar();
    
    document.querySelectorAll('.color-btn').forEach(btn => {
      if(btn !== el) {
        btn.style.opacity = '0.3';
        btn.style.transform = 'scale(0.8)';
      }
    });
    
    setTimeout(runColorQ, 800);
  }else{
    el.classList.add('wrong');
    playSound('wrong');
    setTimeout(() => {
      el.classList.remove('wrong');
      el.style.transform = 'scale(0.9)';
      setTimeout(() => el.style.transform = '', 200);
    }, 400);
  }
}

// === MUSIC GAME - SIMON SAYS PROGRESSION ===
function startMusic(){
  document.getElementById('musicArea').classList.add('active');
  document.getElementById('instructionText').textContent = '¬°Toca las notas!';
  const cfg = LEVELS.music[level];
  
  if(cfg.type === 'free'){
    runMusicFree();
  } else if(cfg.type === 'simon'){
    runMusicSimon(cfg.song);
  }
}

function runMusicFree(){
  const c = document.getElementById('musicContainer');
  c.innerHTML = '<div class="music-header"><div class="music-level-title">üéπ Piano Libre</div><div class="music-instruction">¬°Toca las teclas para hacer m√∫sica!</div></div><div class="piano-container" id="pianoContainer"></div><div class="music-progress" id="musicProgress"></div>';
  
  renderPiano();
  
  const progress = document.getElementById('musicProgress');
  for(let i = 0; i < 5; i++){
    const dot = document.createElement('div');
    dot.className = 'music-dot';
    dot.id = 'dot' + i;
    progress.appendChild(dot);
  }
  
  musicPhase = 'free';
  let freePlayCount = 0;
  window.onFreeNote = () => {
    freePlayCount++;
    const dotIdx = Math.floor(freePlayCount / 3);
    if(dotIdx < 5) {
      document.getElementById('dot' + dotIdx)?.classList.add('completed');
    }
    if(freePlayCount >= 15) {
      setTimeout(completeLevel, 500);
    }
  };
}

function runMusicSimon(songName){
  const fullSequence = SONG_PATTERNS[songName];
  musicRound = 0;
  musicMaxNotes = 2; // Start with 2 notes
  musicPhase = 'idle';
  
  const c = document.getElementById('musicContainer');
  c.innerHTML = '<div class="music-header"><div class="music-level-title">üéπ Simon: ' + songName.charAt(0).toUpperCase() + songName.slice(1) + '</div><div class="music-instruction" id="musicInstr">Escucha la secuencia...</div><div class="music-round-info" id="musicRoundInfo">Ronda 1 - 2 notas</div></div><div class="music-sequence" id="sequenceDisplay"></div><div class="piano-container" id="pianoContainer"></div><div class="music-progress" id="musicProgress"></div>';
  
  renderPiano();
  
  // Start first round
  setTimeout(() => startSimonRound(fullSequence), 1000);
}

function startSimonRound(fullSequence){
  // Get the sequence for this round (progressive: 2, 3, 4, 5... notes)
  musicSequence = fullSequence.slice(0, musicMaxNotes);
  musicUserSequence = [];
  musicNoteIndex = 0;
  musicPhase = 'listen';
  
  // Update round info
  const roundInfo = document.getElementById('musicRoundInfo');
  if(roundInfo) {
    roundInfo.textContent = 'Ronda ' + (musicRound + 1) + ' - ' + musicMaxNotes + ' notas';
  }
  
  // Update instruction
  const instr = document.getElementById('musicInstr');
  if(instr) instr.textContent = 'Escucha la secuencia...';
  
  // Render sequence display
  const seqDisplay = document.getElementById('sequenceDisplay');
  seqDisplay.innerHTML = '';
  musicSequence.forEach((note, i) => {
    const noteEl = document.createElement('div');
    noteEl.className = 'sequence-note';
    noteEl.id = 'seqNote' + i;
    noteEl.style.backgroundColor = PIANO_NOTES.find(n => n.note === note).color;
    noteEl.textContent = PIANO_NOTES.find(n => n.note === note).label;
    seqDisplay.appendChild(noteEl);
  });
  
  // Update progress dots
  const progress = document.getElementById('musicProgress');
  progress.innerHTML = '';
  for(let i = 0; i < totalRounds; i++){
    const dot = document.createElement('div');
    dot.className = 'music-dot';
    if(i < musicRound) dot.classList.add('completed');
    else if(i === musicRound) dot.classList.add('current');
    progress.appendChild(dot);
  }
  
  // Play sequence
  setTimeout(() => playSimonSequence(), 500);
}

function playSimonSequence(){
  musicNoteIndex = 0;
  playNextSimonNote();
}

function playNextSimonNote(){
  if(musicNoteIndex >= musicSequence.length){
    // Finished playing, user's turn
    musicPhase = 'repeat';
    musicNoteIndex = 0;
    musicUserSequence = [];
    const instr = document.getElementById('musicInstr');
    if(instr) instr.textContent = '¬°Tu turno! Repite la secuencia';
    
    // Reset sequence display
    document.querySelectorAll('.sequence-note').forEach(el => {
      el.classList.remove('active', 'played');
    });
    return;
  }
  
  const note = musicSequence[musicNoteIndex];
  const noteData = PIANO_NOTES.find(n => n.note === note);
  
  // Highlight sequence note
  const seqNote = document.getElementById('seqNote' + musicNoteIndex);
  if(seqNote){
    seqNote.classList.add('active');
    setTimeout(() => seqNote.classList.remove('active'), 400);
  }
  
  // Play sound
  playPianoNote(noteData.freq);
  
  // Highlight piano key
  const keys = document.querySelectorAll('.piano-key');
  keys.forEach(k => {
    if(k.dataset.note === note){
      k.classList.add('pressed');
      setTimeout(() => k.classList.remove('pressed'), 300);
    }
  });
  
  musicNoteIndex++;
  setTimeout(playNextSimonNote, 600);
}

function renderPiano(){
  const container = document.getElementById('pianoContainer');
  container.innerHTML = '';
  
  PIANO_NOTES.forEach(note => {
    const key = document.createElement('div');
    key.className = 'piano-key';
    key.dataset.note = note.note;
    key.dataset.freq = note.freq;
    key.innerHTML = '<span class="note-label">'+note.label+'</span>';
    key.style.borderBottom = '4px solid ' + note.color;
    
    key.onclick = () => handlePianoKey(key, note);
    key.ontouchstart = (e) => {
      e.preventDefault();
      handlePianoKey(key, note);
    };
    
    container.appendChild(key);
  });
}

function handlePianoKey(keyEl, note){
  playPianoNote(note.freq);
  keyEl.classList.add('pressed');
  setTimeout(() => keyEl.classList.remove('pressed'), 200);
  
  if(musicPhase === 'free' && window.onFreeNote){
    window.onFreeNote();
  } else if(musicPhase === 'repeat'){
    checkSimonNote(note.note, keyEl);
  }
}

function checkSimonNote(playedNote, keyEl){
  const expectedNote = musicSequence[musicNoteIndex];
  
  // Mark sequence note as played
  const seqNote = document.getElementById('seqNote' + musicNoteIndex);
  if(seqNote) seqNote.classList.add('played');
  
  if(playedNote === expectedNote){
    keyEl.classList.add('correct');
    setTimeout(() => keyEl.classList.remove('correct'), 300);
    
    playSound('correct');
    musicNoteIndex++;
    musicUserSequence.push(playedNote);
    
    // Check if sequence complete for this round
    if(musicUserSequence.length === musicSequence.length){
      playSound('success');
      addStar();
      
      musicRound++;
      
      // Check if game complete
      if(musicRound >= totalRounds){
        setTimeout(completeLevel, 500);
      } else {
        // Next round: add one more note
        musicMaxNotes++;
        
        const fullSequence = SONG_PATTERNS[LEVELS.music[level].song];
        
        // Check if we've used all notes in the song
        if(musicMaxNotes > fullSequence.length) {
          musicMaxNotes = fullSequence.length;
        }
        
        setTimeout(() => startSimonRound(fullSequence), 800);
      }
    }
  } else {
    keyEl.classList.add('wrong');
    setTimeout(() => keyEl.classList.remove('wrong'), 300);
    playSound('wrong');
    
    // Replay the same sequence
    setTimeout(() => {
      musicNoteIndex = 0;
      musicUserSequence = [];
      musicPhase = 'listen';
      const instr = document.getElementById('musicInstr');
      if(instr) instr.textContent = 'Escucha de nuevo...';
      
      // Reset sequence display
      document.querySelectorAll('.sequence-note').forEach(n => n.classList.remove('played'));
      
      setTimeout(playSimonSequence, 500);
    }, 500);
  }
}

// === COMPLETE ===
function completeLevel(){
  playSound('success');
  if(!progress[game]) progress[game] = [];
  if(!progress[game].includes(level)){
    progress[game].push(level);
    saveProg();
  }
  document.getElementById('completeMascot').innerHTML = '<img src="'+AVATARS[avatar]+'" style="width:60px;height:60px">';
  document.getElementById('completeTitle').textContent = '¬°Lo lograste, '+playerName+'!';
  document.getElementById('completeSubtitle').textContent = 'Completaste el nivel';
  document.getElementById('completeStars').innerHTML = '<span class="complete-star earned" style="animation-delay:0s">‚≠ê</span><span class="complete-star earned" style="animation-delay:0.2s">‚≠ê</span><span class="complete-star earned" style="animation-delay:0.4s">‚≠ê</span>';
  const wg = document.getElementById('wordsGrid');
  wg.innerHTML = '';
  learned.slice(0,6).forEach(w => {
    const chip = document.createElement('div');
    chip.className = 'word-chip';
    chip.innerHTML = '<span class="word-emoji">'+w.emoji+'</span><span class="word-es">'+w.es+'</span><span class="word-en">'+w.en+'</span>';
    chip.onclick = () => speak(w.en);
    wg.appendChild(chip);
  });
  document.querySelector('.complete-btn.primary').style.display = level < 4 ? 'flex' : 'none';
  createConfetti();
  showScreen('level-complete');
}

function nextLevel(){playSound('tap');level++;startLevel(level);}
function exitGame(){playSound('tap');showScreen('game-select');}

// === CONFETTI ===
function createConfetti(){
  const c = document.getElementById('confettiContainer');
  c.innerHTML = '';
  const colors = ['#004D98','#A50044','#fef3c7','#22c55e','#fbbf24','#ec4899'];
  for(let i = 0; i < 50; i++){
    const conf = document.createElement('div');
    conf.className = 'confetti';
    conf.style.left = Math.random() * 100 + '%';
    conf.style.background = colors[Math.floor(Math.random() * colors.length)];
    conf.style.animationDuration = (Math.random() * 2 + 2) + 's';
    conf.style.animationDelay = (Math.random() * 0.5) + 's';
    c.appendChild(conf);
  }
  setTimeout(() => c.innerHTML = '', 3500);
}

// === INIT ===
loadProg();
if(playerName){document.getElementById('playerNameInput').value = playerName;}
</script>
</body>
