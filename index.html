<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#6366f1">
<title>Sof√≠a y Noa - Aprende Jugando</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
  --color-primary: #6366f1;
  --color-primary-light: #818cf8;
  --color-primary-dark: #4f46e5;
  --color-secondary: #f97316;
  --color-accent: #10b981;
  --color-warning: #fbbf24;
  --color-error: #ef4444;
  --color-success: #22c55e;
  --color-pink: #ec4899;
  --color-bg: #faf5ff;
  --color-surface: #ffffff;
  --color-surface-alt: #f1f5f9;
  --color-text: #1e1b4b;
  --color-text-secondary: #475569;
  --color-text-muted: #94a3b8;
  --glass-bg: rgba(255, 255, 255, 0.9);
  --glass-border: rgba(255, 255, 255, 0.7);
  --font-family: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif;
  --radius-sm: 10px;
  --radius-md: 14px;
  --radius-lg: 18px;
  --radius-xl: 22px;
  --radius-2xl: 28px;
  --radius-full: 9999px;
  --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
  --shadow-md: 0 6px 16px rgba(0,0,0,0.08);
  --shadow-lg: 0 12px 32px rgba(0,0,0,0.12);
  --shadow-xl: 0 24px 48px rgba(0,0,0,0.15);
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --transition: 300ms cubic-bezier(0.34, 1.56, 0.64, 1);
  --transition-fast: 200ms cubic-bezier(0.34, 1.56, 0.64, 1);
}

*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  -webkit-tap-highlight-color: transparent;
}

html {
  overflow-x: hidden;
  width: 100%;
  height: 100%;
}

body {
  font-family: var(--font-family);
  font-weight: 600;
  overflow-x: hidden;
  overflow-y: auto;
  min-height: 100dvh;
  width: 100%;
  background: var(--color-bg);
  color: var(--color-text);
  padding-top: var(--safe-top);
  padding-bottom: var(--safe-bottom);
  overscroll-behavior: none;
  touch-action: manipulation;
  -webkit-font-smoothing: antialiased;
  line-height: 1.5;
  user-select: none;
}

.bg-layer {
  position: fixed;
  inset: 0;
  z-index: 0;
  pointer-events: none;
}

.bg-gradient {
  background:
    radial-gradient(ellipse 120% 80% at 10% 0%, rgba(99,102,241,0.15) 0%, transparent 50%),
    radial-gradient(ellipse 80% 60% at 90% 100%, rgba(236,72,153,0.12) 0%, transparent 50%),
    radial-gradient(ellipse 60% 50% at 50% 50%, rgba(16,185,129,0.1) 0%, transparent 50%),
    radial-gradient(circle at 20% 80%, rgba(251,191,36,0.1) 0%, transparent 40%),
    var(--color-bg);
}

.screen {
  position: absolute;
  inset: 0;
  display: none;
  flex-direction: column;
  align-items: center;
  z-index: 10;
  padding: 16px;
  padding-top: calc(16px + var(--safe-top));
  padding-bottom: calc(16px + var(--safe-bottom));
}

.screen.active {
  display: flex;
  animation: screenIn var(--transition);
}

@keyframes screenIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

/* ==================== WELCOME SCREEN ==================== */
#welcome {
  justify-content: center;
  gap: 28px;
  text-align: center;
  background: linear-gradient(180deg, rgba(99,102,241,0.1) 0%, var(--color-bg) 60%);
}

.welcome-mascot {
  font-size: 5rem;
  animation: mascotWelcome 2s ease-in-out infinite;
}

@keyframes mascotWelcome {
  0%, 100% { transform: translateY(0) rotate(-3deg); }
  50% { transform: translateY(-12px) rotate(3deg); }
}

.welcome-title {
  font-size: clamp(1.75rem, 8vw, 2.5rem);
  font-weight: 900;
  color: var(--color-text);
  letter-spacing: -0.02em;
}

.welcome-subtitle {
  font-size: 1rem;
  color: var(--color-text-secondary);
  max-width: 300px;
  line-height: 1.6;
}

.welcome-form {
  width: 100%;
  max-width: 320px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.name-input-wrapper {
  position: relative;
}

.name-input {
  width: 100%;
  padding: 22px;
  font-size: 1.25rem;
  font-family: var(--font-family);
  font-weight: 700;
  color: var(--color-text);
  background: var(--color-surface);
  border: 3px solid transparent;
  border-radius: var(--radius-2xl);
  box-shadow: var(--shadow-md);
  transition: all var(--transition-fast);
  text-align: center;
}

.name-input:focus {
  outline: none;
  border-color: var(--color-primary);
  box-shadow: var(--shadow-lg), 0 0 0 4px rgba(99,102,241,0.15);
  transform: scale(1.02);
}

.name-input::placeholder {
  color: var(--color-text-muted);
  font-weight: 600;
}

.start-btn {
  padding: 22px 32px;
  font-size: 1.25rem;
  font-family: var(--font-family);
  font-weight: 800;
  color: white;
  background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
  border: none;
  border-radius: var(--radius-2xl);
  cursor: pointer;
  box-shadow: 0 6px 20px rgba(99,102,241,0.4);
  transition: all var(--transition-fast);
  min-height: 60px;
}

.start-btn:hover {
  transform: translateY(-3px) scale(1.02);
  box-shadow: 0 10px 28px rgba(99,102,241,0.45);
}

.start-btn:active {
  transform: scale(0.98);
}

.start-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

/* ==================== AVATAR SELECTION ==================== */
.avatar-select {
  width: 100%;
  max-width: 320px;
  padding: 20px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  border-radius: var(--radius-2xl);
  border: 2px solid var(--glass-border);
}

.avatar-select-label {
  font-size: 0.9rem;
  color: var(--color-text-secondary);
  margin-bottom: 12px;
  text-align: center;
}

.avatar-options {
  display: flex;
  justify-content: center;
  gap: 12px;
}

.avatar-option {
  width: 60px;
  height: 60px;
  font-size: 2rem;
  background: var(--color-surface);
  border: 3px solid transparent;
  border-radius: var(--radius-xl);
  cursor: pointer;
  transition: all var(--transition-fast);
  display: flex;
  align-items: center;
  justify-content: center;
}

.avatar-option:hover {
  transform: scale(1.1);
  border-color: var(--color-primary-light);
}

.avatar-option.selected {
  border-color: var(--color-primary);
  background: linear-gradient(135deg, rgba(99,102,241,0.1) 0%, rgba(236,72,153,0.1) 100%);
  transform: scale(1.15);
}

/* ==================== MENU SCREEN ==================== */
#menu {
  gap: 20px;
  overflow-y: auto;
}

.menu-header {
  text-align: center;
  margin-bottom: 8px;
}

.greeting {
  font-size: 0.875rem;
  font-weight: 700;
  color: var(--color-primary);
  text-transform: uppercase;
  letter-spacing: 0.12em;
  margin-bottom: 6px;
}

.menu-title {
  font-size: clamp(1.5rem, 7vw, 2.25rem);
  font-weight: 900;
  color: var(--color-text);
  letter-spacing: -0.02em;
}

.player-avatar {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 16px;
  margin-top: 16px;
  padding: 18px 24px;
  background: linear-gradient(135deg, rgba(99,102,241,0.12) 0%, rgba(236,72,153,0.12) 100%);
  border-radius: var(--radius-2xl);
  border: 2px solid rgba(99,102,241,0.2);
}

.avatar-mascot {
  width: 72px;
  height: 72px;
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2.75rem;
  box-shadow: 0 6px 16px rgba(251,191,36,0.35);
  border: 4px solid white;
  animation: mascotBounce 2.5s ease-in-out infinite;
}

@keyframes mascotBounce {
  0%, 100% { transform: translateY(0) rotate(-5deg); }
  50% { transform: translateY(-8px) rotate(5deg); }
}

.player-stats {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
}

.player-name {
  font-size: 1.35rem;
  font-weight: 900;
  color: var(--color-text);
}

.player-level {
  font-size: 0.9rem;
  color: var(--color-primary);
  font-weight: 700;
}

.player-stars {
  font-size: 0.9rem;
  color: var(--color-warning);
}

.progress-overview {
  width: 100%;
  max-width: 400px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  border-radius: var(--radius-2xl);
  padding: 22px;
  border: 2px solid var(--glass-border);
  box-shadow: var(--shadow-md);
}

.progress-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 14px;
}

.progress-title {
  font-size: 0.9rem;
  font-weight: 700;
  color: var(--color-text-secondary);
}

.progress-value {
  font-size: 0.95rem;
  font-weight: 800;
  color: var(--color-primary);
}

.progress-bar-bg {
  height: 10px;
  background: var(--color-surface-alt);
  border-radius: var(--radius-full);
  overflow: hidden;
}

.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-accent) 50%, var(--color-warning) 100%);
  border-radius: var(--radius-full);
  transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.games-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
  width: 100%;
  max-width: 400px;
}

.game-card {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  border-radius: var(--radius-2xl);
  padding: 22px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 14px;
  cursor: pointer;
  border: 2px solid var(--glass-border);
  box-shadow: var(--shadow-md);
  transition: all var(--transition);
  position: relative;
  overflow: hidden;
}

.game-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 5px;
}

.game-card.zoo::before { background: linear-gradient(90deg, var(--color-secondary) 0%, #fb923c 100%); }
.game-card.numbers::before { background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-primary-light) 100%); }
.game-card.sofia::before { background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-pink) 100%); }
.game-card.colors::before { background: linear-gradient(90deg, var(--color-pink) 0%, #f472b6 100%); }

.game-card:hover {
  transform: translateY(-6px) scale(1.02);
  box-shadow: var(--shadow-lg);
}

.game-card:active {
  transform: scale(0.98);
}

.game-icon {
  font-size: 2.75rem;
  line-height: 1;
}

.game-title {
  font-size: 1.05rem;
  font-weight: 800;
  color: var(--color-text);
  text-align: center;
}

.game-levels {
  display: flex;
  gap: 5px;
}

.level-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--color-surface-alt);
  transition: all var(--transition-fast);
}

.level-dot.completed { background: var(--color-success); transform: scale(1.1); }
.level-dot.current { background: var(--color-warning); animation: dotPulse 1.5s ease-in-out infinite; }

@keyframes dotPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.3); }
}

.language-selector {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  width: 100%;
  max-width: 400px;
  padding: 18px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  border-radius: var(--radius-2xl);
  border: 2px solid var(--glass-border);
}

.language-label {
  font-size: 0.9rem;
  font-weight: 700;
  color: var(--color-text-secondary);
}

.language-buttons {
  display: flex;
  gap: 10px;
}

.lang-btn {
  padding: 12px 20px;
  font-size: 0.9rem;
  font-family: var(--font-family);
  font-weight: 700;
  color: var(--color-text-secondary);
  background: var(--color-surface);
  border: 3px solid var(--glass-border);
  border-radius: var(--radius-lg);
  cursor: pointer;
  transition: all var(--transition-fast);
}

.lang-btn.active {
  color: white;
  background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
  border-color: var(--color-primary);
  transform: scale(1.05);
}

.settings-row {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-top: 8px;
  justify-content: center;
}

.settings-btn {
  padding: 14px 22px;
  font-size: 0.9rem;
  font-family: var(--font-family);
  font-weight: 700;
  color: var(--color-text-secondary);
  background: var(--color-surface);
  border: 2px solid var(--glass-border);
  border-radius: var(--radius-xl);
  cursor: pointer;
  transition: all var(--transition-fast);
}

.settings-btn:hover {
  background: var(--color-surface-alt);
  transform: translateY(-2px);
}

/* ==================== GAME SELECT SCREEN ==================== */
#game-select {
  gap: 20px;
}

.game-select-header {
  text-align: center;
}

.game-select-icon {
  font-size: 4rem;
  margin-bottom: 10px;
}

.game-select-title {
  font-size: 1.6rem;
  font-weight: 900;
  color: var(--color-text);
}

.game-select-subtitle {
  font-size: 0.9rem;
  color: var(--color-text-secondary);
}

.levels-grid {
  display: flex;
  flex-direction: column;
  gap: 14px;
  width: 100%;
  max-width: 360px;
}

.level-card {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 18px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  border-radius: var(--radius-2xl);
  border: 2px solid var(--glass-border);
  box-shadow: var(--shadow-sm);
  cursor: pointer;
  transition: all var(--transition);
}

.level-card:hover {
  box-shadow: var(--shadow-md);
  transform: translateX(6px);
}

.level-card.locked {
  opacity: 0.5;
  cursor: not-allowed;
}

.level-card.locked:hover {
  transform: none;
}

.level-number {
  width: 52px;
  height: 52px;
  border-radius: var(--radius-lg);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.35rem;
  font-weight: 900;
  flex-shrink: 0;
}

.level-card.completed .level-number {
  background: linear-gradient(135deg, var(--color-success) 0%, #16a34a 100%);
  color: white;
}

.level-card.current .level-number {
  background: linear-gradient(135deg, var(--color-warning) 0%, #f59e0b 100%);
  color: white;
}

.level-card.locked .level-number {
  background: var(--color-surface-alt);
  color: var(--color-text-muted);
}

.level-info { flex: 1; }

.level-name {
  font-size: 1.05rem;
  font-weight: 800;
  color: var(--color-text);
  margin-bottom: 3px;
}

.level-desc {
  font-size: 0.8rem;
  color: var(--color-text-secondary);
}

.level-status { font-size: 1.35rem; }

/* ==================== GAME SCREEN ==================== */
#game { gap: 12px; }

.game-top-bar {
  position: sticky;
  top: 0;
  z-index: 100;
  width: 100%;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  background: linear-gradient(180deg, var(--color-bg) 60%, transparent 100%);
}

.nav-buttons {
  display: flex;
  gap: 10px;
}

.back-btn {
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--glass-bg);
  border: 2px solid var(--glass-border);
  border-radius: var(--radius-lg);
  font-size: 1.4rem;
  color: var(--color-text);
  cursor: pointer;
  transition: all var(--transition-fast);
  box-shadow: var(--shadow-sm);
}

.back-btn:hover {
  background: var(--color-surface);
  transform: scale(1.05);
}

.menu-btn {
  padding: 12px 18px;
  display: flex;
  align-items: center;
  gap: 8px;
  background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
  border: none;
  border-radius: var(--radius-lg);
  font-size: 0.95rem;
  font-weight: 700;
  color: white;
  cursor: pointer;
  transition: all var(--transition-fast);
  box-shadow: 0 4px 12px rgba(99,102,241,0.35);
}

.menu-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(99,102,241,0.4);
}

.game-level-badge {
  padding: 10px 18px;
  background: var(--glass-bg);
  border: 2px solid var(--glass-border);
  border-radius: var(--radius-full);
  font-size: 0.85rem;
  font-weight: 700;
  color: var(--color-text-secondary);
}

.progress-stars {
  display: flex;
  gap: 6px;
}

.progress-star {
  font-size: 1.35rem;
  color: #e2e8f0;
  transition: all var(--transition);
}

.progress-star.earned {
  color: var(--color-warning);
  text-shadow: 0 2px 10px rgba(251,191,36,0.5);
  animation: starEarned var(--transition);
}

@keyframes starEarned {
  0% { transform: scale(0) rotate(-180deg); }
  70% { transform: scale(1.4) rotate(10deg); }
  100% { transform: scale(1) rotate(0deg); }
}

.game-instruction {
  text-align: center;
  padding: 18px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  border-radius: var(--radius-2xl);
  border: 2px solid var(--glass-border);
  width: 100%;
  max-width: 400px;
}

.instruction-text {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--color-text);
}

.instruction-name {
  color: var(--color-primary);
  font-weight: 800;
}

.game-area {
  flex: 1;
  display: none;
  width: 100%;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  overflow: hidden;
  padding: 12px;
}

.game-area.active {
  display: flex;
}

/* ==================== MEMORY GAME ==================== */
.memory-grid {
  display: grid;
  gap: 14px;
  padding: 14px;
  width: 100%;
  max-width: 420px;
  justify-content: center;
}

.memory-card {
  aspect-ratio: 1;
  position: relative;
  transform-style: preserve-3d;
  transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
  cursor: pointer;
  min-width: 70px;
  min-height: 70px;
}

.memory-card.flipped { transform: rotateY(180deg); }
.memory-card.matched { pointer-events: none; }

.card-face {
  position: absolute;
  inset: 0;
  backface-visibility: hidden;
  border-radius: var(--radius-xl);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: clamp(2rem, 9vw, 3.5rem);
  box-shadow: var(--shadow-md);
  border: 4px solid transparent;
}

.card-front {
  background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
  border-color: var(--color-primary-light);
}

.card-front::after {
  content: '?';
  font-size: 1.75rem;
  font-weight: 800;
  color: var(--color-primary);
}

.card-back {
  background: var(--color-surface);
  transform: rotateY(180deg);
  border-color: var(--color-accent);
}

.memory-card.matched .card-back {
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  border-color: var(--color-warning);
  animation: matchPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes matchPop {
  0%, 100% { transform: rotateY(180deg) scale(1); }
  50% { transform: rotateY(180deg) scale(1.12); }
}

/* ==================== NUMBERS GAME ==================== */
.numbers-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 28px;
  width: 100%;
  max-width: 400px;
}

.number-intro-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 24px;
  padding: 36px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  border-radius: var(--radius-2xl);
  border: 2px solid var(--glass-border);
  cursor: pointer;
  box-shadow: var(--shadow-lg);
  transition: all var(--transition);
}

.number-intro-card:hover { transform: scale(1.03); }

.number-big {
  font-size: 7rem;
  font-weight: 900;
  color: var(--color-primary);
  text-shadow: 0 6px 20px rgba(99,102,241,0.35);
}

.number-objects {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 14px;
}

.number-object { font-size: 3.5rem; }

.number-prompt {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--color-text-secondary);
}

.counting-objects {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 18px;
  padding: 28px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  border-radius: var(--radius-2xl);
  border: 2px solid var(--glass-border);
}

.counting-item {
  font-size: 3.5rem;
  padding: 14px;
  border-radius: var(--radius-lg);
  cursor: pointer;
  transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.counting-item.touched {
  background: #dcfce7;
  transform: scale(1.15) rotate(5deg);
}

.counting-prompt {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--color-text);
}

.counting-display {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 14px;
  padding: 28px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  border-radius: var(--radius-2xl);
  border: 2px solid var(--glass-border);
}

.counting-display-item { font-size: 3rem; }

.counting-question {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--color-text);
}

.counting-options {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 14px;
}

.count-option {
  width: 76px;
  height: 76px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2.2rem;
  font-weight: 900;
  background: var(--color-surface);
  border: 4px solid var(--glass-border);
  border-radius: var(--radius-xl);
  cursor: pointer;
  transition: all var(--transition-fast);
  box-shadow: var(--shadow-sm);
}

.count-option:hover {
  transform: scale(1.08);
  border-color: var(--color-primary-light);
}

.count-option.correct {
  background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
  border-color: var(--color-success);
  transform: scale(1.1);
}

.count-option.wrong {
  animation: shake 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  border-color: var(--color-error);
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-10px); }
  75% { transform: translateX(10px); }
}

.order-slots {
  display: flex;
  gap: 14px;
  justify-content: center;
}

.order-slot {
  width: 64px;
  height: 64px;
  border: 4px dashed var(--color-text-muted);
  border-radius: var(--radius-lg);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.6rem;
  font-weight: 800;
  color: var(--color-text-muted);
  transition: all var(--transition-fast);
}

.order-slot.filled {
  border-style: solid;
  border-color: var(--color-success);
  background: #dcfce7;
  color: var(--color-text);
  transform: scale(1.05);
}

.order-items {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 14px;
  padding: 18px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  border-radius: var(--radius-2xl);
  border: 2px solid var(--glass-border);
}

.order-item {
  width: 64px;
  height: 64px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2.2rem;
  font-weight: 900;
  background: var(--color-surface);
  border: 3px solid var(--glass-border);
  border-radius: var(--radius-lg);
  cursor: pointer;
  transition: all var(--transition-fast);
  box-shadow: var(--shadow-sm);
}

.order-item:hover { transform: scale(1.1); }
.order-item.used { opacity: 0.3; pointer-events: none; }

/* ==================== SOFIA GAME ==================== */
.sofia-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 24px;
  width: 100%;
  max-width: 400px;
}

.sofia-plane {
  font-size: 4.5rem;
  animation: planeFly 3s ease-in-out infinite;
}

@keyframes planeFly {
  0%, 100% { transform: translateX(-25px) rotate(-8deg); }
  50% { transform: translateX(25px) rotate(8deg); }
}

.sofia-country-card {
  text-align: center;
  padding: 28px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  border-radius: var(--radius-2xl);
  border: 2px solid var(--glass-border);
  width: 100%;
  box-shadow: var(--shadow-lg);
}

.sofia-flag { 
  font-size: 5.5rem; 
  margin-bottom: 12px;
  animation: flagWave 2s ease-in-out infinite;
}

@keyframes flagWave {
  0%, 100% { transform: rotate(-3deg); }
  50% { transform: rotate(3deg); }
}

.sofia-country-name {
  font-size: 1.6rem;
  font-weight: 900;
  color: var(--color-text);
  margin-bottom: 6px;
}

.sofia-capital-hint {
  font-size: 0.85rem;
  color: var(--color-text-muted);
  margin-bottom: 8px;
}

.sofia-question {
  font-size: 0.95rem;
  color: var(--color-text-secondary);
  font-weight: 600;
}

.sofia-capitals {
  display: flex;
  flex-direction: column;
  gap: 14px;
  width: 100%;
}

.capital-btn {
  padding: 22px;
  font-size: 1.3rem;
  font-family: var(--font-family);
  font-weight: 800;
  color: var(--color-text);
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  border: 3px solid var(--glass-border);
  border-radius: var(--radius-2xl);
  cursor: pointer;
  transition: all var(--transition-fast);
  box-shadow: var(--shadow-sm);
}

.capital-btn:hover {
  transform: translateY(-3px) scale(1.02);
  box-shadow: var(--shadow-md);
  border-color: var(--color-primary-light);
}

.capital-btn:active { transform: scale(0.98); }

.capital-btn.correct {
  background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
  border-color: var(--color-success);
}

.sofia-fact {
  font-size: 0.85rem;
  color: var(--color-accent);
  font-weight: 600;
  font-style: italic;
  margin-top: 8px;
  padding: 12px;
  background: rgba(16,185,129,0.1);
  border-radius: var(--radius-lg);
}

/* ==================== COLORS GAME ==================== */
.colors-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 24px;
  width: 100%;
  max-width: 400px;
}

.color-target {
  text-align: center;
  padding: 28px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  border-radius: var(--radius-2xl);
  border: 2px solid var(--glass-border);
  width: 100%;
}

.target-emoji { font-size: 5.5rem; display: block; margin-bottom: 14px; }
.target-question { font-size: 1.05rem; color: var(--color-text-secondary); }
.target-word { font-weight: 800; color: var(--color-text); }

.color-palette {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 18px;
}

.color-btn {
  width: 76px;
  height: 76px;
  border-radius: var(--radius-2xl);
  cursor: pointer;
  border: 5px solid white;
  transition: all var(--transition-fast);
  box-shadow: var(--shadow-md);
}

.color-btn:hover { transform: scale(1.15) rotate(5deg); }
.color-btn.selected {
  border-color: var(--color-text);
  transform: scale(1.2);
}

/* ==================== VOCABULARY POPUP ==================== */
.vocab-popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.8);
  background: var(--color-surface);
  border-radius: var(--radius-2xl);
  padding: 32px 40px;
  text-align: center;
  box-shadow: var(--shadow-xl);
  z-index: 90;
  opacity: 0;
  pointer-events: none;
  transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  border: 3px solid var(--glass-border);
}

.vocab-popup.show {
  transform: translate(-50%, -50%) scale(1);
  opacity: 1;
}

.vocab-emoji { font-size: 4.5rem; margin-bottom: 14px; }
.vocab-word { font-size: 1.6rem; font-weight: 800; color: var(--color-primary); margin-bottom: 6px; }
.vocab-translation { font-size: 1.15rem; color: var(--color-accent); font-weight: 700; }

/* ==================== LEVEL COMPLETE ==================== */
#level-complete {
  background: linear-gradient(180deg, rgba(99,102,241,0.12) 0%, var(--color-bg) 50%);
  text-align: center;
  gap: 22px;
}

.complete-mascot {
  font-size: 5.5rem;
  animation: mascotCelebrate 1s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes mascotCelebrate {
  0% { transform: scale(0) rotate(-20deg); }
  60% { transform: scale(1.3) rotate(10deg); }
  100% { transform: scale(1) rotate(0deg); }
}

.complete-title {
  font-size: clamp(1.75rem, 8vw, 2.5rem);
  font-weight: 900;
  color: var(--color-text);
}

.complete-subtitle {
  font-size: 1.05rem;
  color: var(--color-text-secondary);
}

.complete-stars {
  display: flex;
  justify-content: center;
  gap: 14px;
}

.complete-star {
  font-size: 2.75rem;
  color: #e2e8f0;
  animation: starAppear 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) backwards;
}

.complete-star.earned { color: var(--color-warning); }
.complete-star:nth-child(1) { animation-delay: 0.2s; }
.complete-star:nth-child(2) { animation-delay: 0.4s; }
.complete-star:nth-child(3) { animation-delay: 0.6s; }

@keyframes starAppear {
  0% { transform: scale(0) rotate(-180deg); opacity: 0; }
  100% { transform: scale(1) rotate(0deg); opacity: 1; }
}

.words-learned {
  width: 100%;
  max-width: 350px;
}

.words-title {
  font-size: 0.9rem;
  font-weight: 700;
  color: var(--color-text-secondary);
  margin-bottom: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.words-grid {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 14px;
}

.word-chip {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 14px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  border-radius: var(--radius-xl);
  border: 2px solid var(--glass-border);
  animation: wordChipIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) backwards;
}

.word-chip:nth-child(1) { animation-delay: 0.3s; }
.word-chip:nth-child(2) { animation-delay: 0.4s; }
.word-chip:nth-child(3) { animation-delay: 0.5s; }
.word-chip:nth-child(4) { animation-delay: 0.6s; }
.word-chip:nth-child(5) { animation-delay: 0.7s; }
.word-chip:nth-child(6) { animation-delay: 0.8s; }

@keyframes wordChipIn {
  from { transform: translateY(20px) scale(0.8); opacity: 0; }
  to { transform: translateY(0) scale(1); opacity: 1; }
}

.word-emoji { font-size: 2rem; }
.word-es { font-size: 0.8rem; font-weight: 800; color: var(--color-primary); }
.word-en { font-size: 0.7rem; color: var(--color-accent); }

.complete-actions {
  display: flex;
  flex-direction: column;
  gap: 14px;
  width: 100%;
  max-width: 280px;
}

.complete-btn {
  padding: 18px 24px;
  font-size: 1.05rem;
  font-family: var(--font-family);
  font-weight: 800;
  border: none;
  border-radius: var(--radius-2xl);
  cursor: pointer;
  transition: all var(--transition-fast);
  min-height: 56px;
}

.complete-btn.primary {
  background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
  color: white;
  box-shadow: 0 6px 20px rgba(99,102,241,0.4);
}

.complete-btn.primary:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 24px rgba(99,102,241,0.45);
}

.complete-btn.secondary {
  background: var(--glass-bg);
  color: var(--color-text);
  border: 3px solid var(--glass-border);
}

.complete-btn:active { transform: scale(0.98); }

/* ==================== CONFETTI ==================== */
.confetti-container {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 200;
  overflow: hidden;
}

.confetti {
  position: absolute;
  width: 12px;
  height: 12px;
  top: -12px;
  animation: confettiFall linear forwards;
}

@keyframes confettiFall {
  0% { transform: translateY(0) rotate(0deg); opacity: 1; }
  100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
}

/* ==================== RESPONSIVE ==================== */
/* M√≥viles peque√±os (iPhone SE, etc) */
@media (max-width: 360px) {
  .screen { padding: 12px; }
  .welcome-mascot { font-size: 4rem; }
  .welcome-title { font-size: 1.5rem; }
  .games-grid { gap: 12px; }
  .game-card { padding: 16px; }
  .game-icon { font-size: 2.25rem; }
  .game-title { font-size: 0.9rem; }
  .memory-card { min-width: 60px; min-height: 60px; }
  .avatar-option { width: 50px; height: 50px; font-size: 1.5rem; }
  .count-option { width: 65px; height: 65px; font-size: 1.8rem; }
  .color-btn { width: 65px; height: 65px; }
}

/* M√≥viles medianos (iPhone 12/13, Pixel, etc) */
@media (min-width: 361px) and (max-width: 413px) {
  .game-card { padding: 20px; }
  .memory-card { min-width: 68px; min-height: 68px; }
}

/* M√≥viles grandes (iPhone Pro Max, etc) */
@media (min-width: 414px) and (max-width: 767px) {
  .games-grid { max-width: 420px; }
  .game-card { padding: 24px; }
}

/* Tablets */
@media (min-width: 768px) {
  .games-grid { grid-template-columns: repeat(4, 1fr); max-width: 700px; }
  .game-card { padding: 28px; }
  .memory-grid { max-width: 520px; }
  .welcome-form { max-width: 380px; }
  .progress-overview { max-width: 500px; }
  .language-selector { max-width: 500px; }
}

/* Pantallas con poca altura */
@media (max-height: 600px) {
  .screen { padding: 12px; }
  .welcome-mascot { font-size: 4rem; }
  .complete-mascot { font-size: 4.5rem; }
  #welcome { gap: 20px; }
  #level-complete { gap: 16px; }
  .number-big { font-size: 5rem; }
  .sofia-flag { font-size: 4rem; }
}

/* Modo paisaje en m√≥viles */
@media (max-height: 500px) and (orientation: landscape) {
  .screen { padding: 8px; }
  .welcome-mascot { font-size: 3rem; }
  .game-instruction { padding: 12px; }
  .instruction-text { font-size: 0.95rem; }
}

/* Accesibilidad: reducir movimiento */
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}
</style>
</head>
<body>
<div class="bg-layer bg-gradient"></div>

<!-- WELCOME SCREEN -->
<div id="welcome" class="screen active">
  <div class="welcome-mascot">üåü</div>
  <h1 class="welcome-title" data-i18n="welcome_title">¬°Hola, peque√±o/a!</h1>
  <p class="welcome-subtitle" data-i18n="welcome_subtitle">¬øC√≥mo te llamas? Tu pap√° o mam√° puede escribir tu nombre</p>
  
  <form class="welcome-form" onsubmit="return startGame(event)">
    <div class="name-input-wrapper">
      <input type="text" class="name-input" id="playerNameInput" placeholder="" maxlength="12" autocomplete="off" autocapitalize="words" required>
    </div>
    
    <div class="avatar-select">
      <div class="avatar-select-label" data-i18n="choose_mascot">Elige tu mascota:</div>
      <div class="avatar-options" id="avatarOptions">
        <div class="avatar-option selected" data-avatar="üß∏" onclick="selectAvatar('üß∏')">üß∏</div>
        <div class="avatar-option" data-avatar="üê∞" onclick="selectAvatar('üê∞')">üê∞</div>
        <div class="avatar-option" data-avatar="ü¶ä" onclick="selectAvatar('ü¶ä')">ü¶ä</div>
        <div class="avatar-option" data-avatar="üê±" onclick="selectAvatar('üê±')">üê±</div>
      </div>
    </div>
    
    <button type="submit" class="start-btn" id="startBtn" data-i18n="start_btn">Comenzar aventura</button>
  </form>
</div>

<!-- MENU SCREEN -->
<div id="menu" class="screen">
  <div class="menu-header">
    <div class="greeting" data-i18n="greeting">Bienvenido/a de nuevo</div>
    <h1 class="menu-title" data-i18n="menu_title">¬øQu√© quieres aprender hoy?</h1>
    <div class="player-avatar">
      <div class="avatar-mascot" id="menuMascot">üß∏</div>
      <div class="player-stats">
        <div class="player-name" id="playerNameDisplay">Sof√≠a</div>
        <div class="player-level" id="playerLevelDisplay">Nivel 1</div>
        <div class="player-stars" id="playerStarsDisplay">‚≠ê 0</div>
      </div>
    </div>
  </div>
  
  <div class="progress-overview">
    <div class="progress-header">
      <span class="progress-title" data-i18n="progress_title">Progreso total</span>
      <span class="progress-value" id="totalProgress">0%</span>
    </div>
    <div class="progress-bar-bg">
      <div class="progress-bar-fill" id="progressFill" style="width: 0%"></div>
    </div>
  </div>
  
  <div class="games-grid">
    <div class="game-card zoo" onclick="openGameSelect('zoo')">
      <div class="game-icon">ü¶Å</div>
      <div class="game-title" data-i18n="game_zoo">El Gran Zoo</div>
      <div class="game-levels" id="zooLevels"></div>
    </div>
    <div class="game-card numbers" onclick="openGameSelect('numbers')">
      <div class="game-icon">üî¢</div>
      <div class="game-title" data-i18n="game_numbers">N√∫meros</div>
      <div class="game-levels" id="numbersLevels"></div>
    </div>
    <div class="game-card sofia" onclick="openGameSelect('sofia')">
      <div class="game-icon">‚úàÔ∏è</div>
      <div class="game-title" data-i18n="game_sofia">El Mundo de Sof√≠a</div>
      <div class="game-levels" id="sofiaLevels"></div>
    </div>
    <div class="game-card colors" onclick="openGameSelect('colors')">
      <div class="game-icon">üé®</div>
      <div class="game-title" data-i18n="game_colors">Colores</div>
      <div class="game-levels" id="colorsLevels"></div>
    </div>
  </div>
  
  <div class="language-selector">
    <span class="language-label" data-i18n="language_label">Idioma / Language / Limba:</span>
    <div class="language-buttons">
      <button class="lang-btn active" data-lang="es" onclick="setLanguage('es')">üá™üá∏ ES</button>
      <button class="lang-btn" data-lang="en" onclick="setLanguage('en')">üá¨üáß EN</button>
      <button class="lang-btn" data-lang="ro" onclick="setLanguage('ro')">üá∑üá¥ RO</button>
    </div>
  </div>
  
  <div class="settings-row">
    <button class="settings-btn" onclick="changeName()" data-i18n="btn_change_name">Cambiar nombre</button>
    <button class="settings-btn" onclick="resetProgress()" data-i18n="btn_reset">Reiniciar</button>
  </div>
</div>

<!-- GAME SELECT SCREEN -->
<div id="game-select" class="screen">
  <div class="game-select-header">
    <div class="game-select-icon" id="gameSelectIcon">ü¶Å</div>
    <h1 class="game-select-title" id="gameSelectTitle">El Gran Zoo</h1>
    <p class="game-select-subtitle" id="gameSelectSubtitle" data-i18n="select_level">Elige un nivel para empezar</p>
  </div>
  <div class="levels-grid" id="levelsGrid"></div>
  <button class="back-btn" onclick="goToMenu()" style="align-self: flex-start; margin-top: 16px;">‚Üê</button>
</div>

<!-- GAME SCREEN -->
<div id="game" class="screen">
  <div class="game-top-bar">
    <div class="nav-buttons">
      <button class="back-btn" onclick="exitGame()">‚Üê</button>
      <button class="menu-btn" onclick="goToMenu()">üè† <span data-i18n="btn_menu">Men√∫</span></button>
    </div>
    <div class="game-level-badge" id="levelBadge">Nivel 1</div>
    <div class="progress-stars" id="progressStars"></div>
  </div>
  
  <div class="game-instruction" id="gameInstruction">
    <p class="instruction-text">
      <span id="instructionPlayerName">Sof√≠a</span>,
      <span id="instructionText">encuentra las parejas de animales</span>
    </p>
  </div>
  
  <div class="game-area" id="memoryArea">
    <div class="memory-grid" id="memoryGrid"></div>
  </div>
  
  <div class="game-area" id="numbersArea">
    <div class="numbers-container" id="numbersContainer"></div>
  </div>
  
  <div class="game-area" id="sofiaArea">
    <div class="sofia-container" id="sofiaContainer"></div>
  </div>
  
  <div class="game-area" id="colorsArea">
    <div class="colors-container" id="colorsContainer"></div>
  </div>
</div>

<!-- VOCABULARY POPUP -->
<div class="vocab-popup" id="vocabPopup">
  <div class="vocab-emoji" id="vocabEmoji"></div>
  <div class="vocab-word" id="vocabWord"></div>
  <div class="vocab-translation" id="vocabTranslation"></div>
</div>

<!-- LEVEL COMPLETE SCREEN -->
<div id="level-complete" class="screen">
  <div class="complete-mascot" id="completeMascot">üß∏</div>
  <h1 class="complete-title" id="completeTitle">¬°Lo lograste!</h1>
  <p class="complete-subtitle" id="completeSubtitle">Completaste el nivel</p>
  <div class="complete-stars" id="completeStars">
    <span class="complete-star earned">‚≠ê</span>
    <span class="complete-star earned">‚≠ê</span>
    <span class="complete-star earned">‚≠ê</span>
  </div>
  <div class="words-learned">
    <div class="words-title">
      <span>üìö</span>
      <span data-i18n="words_learned">Palabras aprendidas</span>
    </div>
    <div class="words-grid" id="wordsGrid"></div>
  </div>
  <div class="complete-actions">
    <button class="complete-btn primary" id="nextLevelBtn" onclick="nextLevel()" data-i18n="btn_next_level">Siguiente nivel</button>
    <button class="complete-btn secondary" onclick="goToMenu()" data-i18n="btn_back_menu">Volver al men√∫</button>
  </div>
</div>

<!-- CONFETTI -->
<div class="confetti-container" id="confettiContainer"></div>

<script>
// ============================================
// TRANSLATIONS
// ============================================
const TRANSLATIONS = {
  es: {
    welcome_title: "¬°Hola, peque√±o/a!",
    welcome_subtitle: "¬øC√≥mo te llamas? Tu pap√° o mam√° puede escribir tu nombre",
    start_btn: "Comenzar aventura",
    choose_mascot: "Elige tu mascota:",
    greeting: "Bienvenido/a de nuevo",
    menu_title: "¬øQu√© quieres aprender hoy?",
    progress_title: "Progreso total",
    game_zoo: "El Gran Zoo",
    game_numbers: "N√∫meros",
    game_sofia: "El Mundo de Sof√≠a",
    game_colors: "Colores",
    language_label: "Idioma / Language / Limba:",
    btn_change_name: "Cambiar nombre",
    btn_reset: "Reiniciar",
    select_level: "Elige un nivel para empezar",
    btn_menu: "Men√∫",
    words_learned: "Palabras aprendidas",
    btn_next_level: "Siguiente nivel",
    btn_back_menu: "Volver al men√∫",
    level: "Nivel",
    beginner: "Principiante",
    explorer: "Explorador",
    adventurer: "Aventurero",
    master: "Maestro",
    name_placeholder: "Tu nombre...",
    sofia_question: "¬øCu√°l es su capital?",
    counting_question: "¬øCu√°ntos hay?",
    counting_prompt: "¬°Toca cada objeto mientras cuentas!",
    number_prompt: "¬°Toca para continuar!",
    color_question: "¬øDe qu√© color es",
    complete_achievement: "Completaste",
    levels: {
      zoo: [
        {name: "Memoria F√°cil", desc: "Encuentra 3 parejas", instruction: "¬°Encuentra las parejas de animales!"},
        {name: "Memoria Media", desc: "Encuentra 4 parejas", instruction: "¬°Encuentra todas las parejas!"},
        {name: "Memoria Dif√≠cil", desc: "Encuentra 6 parejas", instruction: "¬°Encuentra todas las parejas!"},
        {name: "Sonidos del Zoo", desc: "Aprende m√°s animales", instruction: "¬°Encuentra los animales!"},
        {name: "Safari Completo", desc: "El reto m√°s grande", instruction: "¬°Completa el safari!"}
      ],
      numbers: [
        {name: "Conoce los N√∫meros", desc: "Aprende del 1 al 3", instruction: "¬°Vamos a conocer los n√∫meros!"},
        {name: "Contemos Juntos", desc: "Cuenta objetos tocando", instruction: "¬°Toca cada objeto mientras cuentas!"},
        {name: "¬øCu√°ntos Hay?", desc: "Adivina la cantidad", instruction: "¬øCu√°ntos objetos ves?"},
        {name: "Ordena los N√∫meros", desc: "Pon en orden", instruction: "¬°Pon los n√∫meros en orden!"},
        {name: "Cuenta hasta 10", desc: "N√∫meros grandes", instruction: "¬øCu√°ntos objetos hay?"}
      ],
      sofia: [
        {name: "Espa√±a y Ruman√≠a", desc: "Dos pa√≠ses", instruction: "¬°Aprende sobre estos pa√≠ses!"},
        {name: "M√°s Pa√≠ses", desc: "Tres pa√≠ses", instruction: "¬°Descubre nuevas capitales!"},
        {name: "Por Europa", desc: "Cinco pa√≠ses", instruction: "¬°Viaja por Europa!"},
        {name: "El Mundo", desc: "Siete pa√≠ses", instruction: "¬°Explora el mundo!"},
        {name: "Viaje Global", desc: "Todos los pa√≠ses", instruction: "¬°Convi√©rtete en viajero experto!"}
      ],
      colors: [
        {name: "Colores B√°sicos", desc: "Colores principales", instruction: "¬øDe qu√© color es?"},
        {name: "M√°s Colores", desc: "Aprende m√°s", instruction: "¬øDe qu√© color es?"},
        {name: "Rosa y Blanco", desc: "Nuevos colores", instruction: "¬øDe qu√© color es?"},
        {name: "Todos los Colores", desc: "Todos los colores", instruction: "¬øDe qu√© color es?"},
        {name: "Maestro de Colores", desc: "Reto final", instruction: "¬°Demuestra lo que sabes!"}
      ]
    }
  },
  en: {
    welcome_title: "Hello, little one!",
    welcome_subtitle: "What's your name? Your mom or dad can write it",
    start_btn: "Start adventure",
    choose_mascot: "Choose your mascot:",
    greeting: "Welcome back",
    menu_title: "What do you want to learn today?",
    progress_title: "Total progress",
    game_zoo: "The Big Zoo",
    game_numbers: "Numbers",
    game_sofia: "Sofia's World",
    game_colors: "Colors",
    language_label: "Language / Limba:",
    btn_change_name: "Change name",
    btn_reset: "Reset",
    select_level: "Choose a level to start",
    btn_menu: "Menu",
    words_learned: "Words learned",
    btn_next_level: "Next level",
    btn_back_menu: "Back to menu",
    level: "Level",
    beginner: "Beginner",
    explorer: "Explorer",
    adventurer: "Adventurer",
    master: "Master",
    name_placeholder: "Your name...",
    sofia_question: "What is its capital?",
    counting_question: "How many are there?",
    counting_prompt: "Tap each object while counting!",
    number_prompt: "Tap to continue!",
    color_question: "What color is",
    complete_achievement: "You completed",
    levels: {
      zoo: [
        {name: "Easy Memory", desc: "Find 3 pairs", instruction: "Find the animal pairs!"},
        {name: "Medium Memory", desc: "Find 4 pairs", instruction: "Find all pairs!"},
        {name: "Hard Memory", desc: "Find 6 pairs", instruction: "Find all pairs!"},
        {name: "Zoo Sounds", desc: "Learn more animals", instruction: "Find the animals!"},
        {name: "Complete Safari", desc: "The biggest challenge", instruction: "Complete the safari!"}
      ],
      numbers: [
        {name: "Meet Numbers", desc: "Learn 1 to 3", instruction: "Let's meet the numbers!"},
        {name: "Let's Count", desc: "Count by tapping", instruction: "Tap each object while counting!"},
        {name: "How Many?", desc: "Guess the amount", instruction: "How many objects do you see?"},
        {name: "Order Numbers", desc: "Put in order", instruction: "Put the numbers in order!"},
        {name: "Count to 10", desc: "Big numbers", instruction: "How many objects are there?"}
      ],
      sofia: [
        {name: "Spain & Romania", desc: "Two countries", instruction: "Learn about these countries!"},
        {name: "More Countries", desc: "Three countries", instruction: "Discover new capitals!"},
        {name: "Around Europe", desc: "Five countries", instruction: "Travel through Europe!"},
        {name: "The World", desc: "Seven countries", instruction: "Explore the world!"},
        {name: "Global Journey", desc: "All countries", instruction: "Become an expert traveler!"}
      ],
      colors: [
        {name: "Basic Colors", desc: "Main colors", instruction: "What color is it?"},
        {name: "More Colors", desc: "Learn more", instruction: "What color is it?"},
        {name: "Pink & White", desc: "New colors", instruction: "What color is it?"},
        {name: "All Colors", desc: "All colors", instruction: "What color is it?"},
        {name: "Color Master", desc: "Final challenge", instruction: "Show what you know!"}
      ]
    }
  },
  ro: {
    welcome_title: "BunƒÉ, micu»õule!",
    welcome_subtitle: "Cum te cheamƒÉ? Mami sau tati poate scrie numele tƒÉu",
    start_btn: "√éncepe aventura",
    choose_mascot: "Alege mascotƒÉ:",
    greeting: "Bine ai revenit",
    menu_title: "Ce vrei sƒÉ √Ænve»õi astƒÉzi?",
    progress_title: "Progres total",
    game_zoo: "Marea GrƒÉdinƒÉ ZoologicƒÉ",
    game_numbers: "Numere",
    game_sofia: "Lumea Sofiei",
    game_colors: "Culori",
    language_label: "LimbƒÉ / Language:",
    btn_change_name: "SchimbƒÉ numele",
    btn_reset: "ReseteazƒÉ",
    select_level: "Alege un nivel pentru a √Æncepe",
    btn_menu: "Meniu",
    words_learned: "Cuvinte √ÆnvƒÉ»õate",
    btn_next_level: "Nivelul urmƒÉtor",
    btn_back_menu: "√énapoi la meniu",
    level: "Nivel",
    beginner: "√éncepƒÉtor",
    explorer: "Explorator",
    adventurer: "Aventurier",
    master: "Maestru",
    name_placeholder: "Numele tƒÉu...",
    sofia_question: "Care este capitala?",
    counting_question: "C√¢te sunt?",
    counting_prompt: "Atinge fiecare obiect √Æn timp ce numeri!",
    number_prompt: "Atinge pentru a continua!",
    color_question: "Ce culoare are",
    complete_achievement: "Ai completat",
    levels: {
      zoo: [
        {name: "Memorie U»ôoarƒÉ", desc: "GƒÉse»ôte 3 perechi", instruction: "GƒÉse»ôte perechile de animale!"},
        {name: "Memorie Medie", desc: "GƒÉse»ôte 4 perechi", instruction: "GƒÉse»ôte toate perechile!"},
        {name: "Memorie DificilƒÉ", desc: "GƒÉse»ôte 6 perechi", instruction: "GƒÉse»ôte toate perechile!"},
        {name: "Sunetele Zoo", desc: "√énva»õƒÉ mai multe animale", instruction: "GƒÉse»ôte animalele!"},
        {name: "Safari Complet", desc: "Cea mai mare provocare", instruction: "CompleteazƒÉ safari-ul!"}
      ],
      numbers: [
        {name: "Cunoa»ôte Numerele", desc: "√énva»õƒÉ de la 1 la 3", instruction: "Hai sƒÉ cunoa»ôtem numerele!"},
        {name: "SƒÉ NumƒÉrƒÉm", desc: "NumƒÉrƒÉ ating√¢nd", instruction: "Atinge fiecare obiect √Æn timp ce numeri!"},
        {name: "C√¢te Sunt?", desc: "Ghice»ôte cantitatea", instruction: "C√¢te obiecte vezi?"},
        {name: "OrdoneazƒÉ Numerele", desc: "Pune √Æn ordine", instruction: "Pune numerele √Æn ordine!"},
        {name: "NumƒÉrƒÉ p√¢nƒÉ la 10", desc: "Numere mari", instruction: "C√¢te obiecte sunt?"}
      ],
      sofia: [
        {name: "Spania »ôi Rom√¢nia", desc: "DouƒÉ »õƒÉri", instruction: "√énva»õƒÉ despre aceste »õƒÉri!"},
        {name: "Mai Multe »öƒÉri", desc: "Trei »õƒÉri", instruction: "DescoperƒÉ noi capitale!"},
        {name: "Prin Europa", desc: "Cinci »õƒÉri", instruction: "CƒÉlƒÉtore»ôte prin Europa!"},
        {name: "Lumea", desc: "»òapte »õƒÉri", instruction: "ExploreazƒÉ lumea!"},
        {name: "CƒÉlƒÉtorie GlobalƒÉ", desc: "Toate »õƒÉrile", instruction: "Devine cƒÉlƒÉtor expert!"}
      ],
      colors: [
        {name: "Culori de BazƒÉ", desc: "Culorile principale", instruction: "Ce culoare are?"},
        {name: "Mai Multe Culori", desc: "√énva»õƒÉ mai multe", instruction: "Ce culoare are?"},
        {name: "Roz »ôi Alb", desc: "Culori noi", instruction: "Ce culoare are?"},
        {name: "Toate Culorile", desc: "Toate culorile", instruction: "Ce culoare are?"},
        {name: "Maestru al Culorilor", desc: "Provocarea finalƒÉ", instruction: "AratƒÉ ce »ôtii!"}
      ]
    }
  }
};

// ============================================
// GAME DATA
// ============================================
const ZOO_DATA = {
  animals: [
    {emoji: "ü¶Å", es: "LE√ìN", en: "Lion"},
    {emoji: "üêØ", es: "TIGRE", en: "Tiger"},
    {emoji: "üêò", es: "ELEFANTE", en: "Elephant"},
    {emoji: "ü¶í", es: "JIRAFA", en: "Giraffe"},
    {emoji: "ü¶ì", es: "CEBRA", en: "Zebra"},
    {emoji: "üêí", es: "MONO", en: "Monkey"},
    {emoji: "üêÆ", es: "VACA", en: "Cow"},
    {emoji: "üê∑", es: "CERDO", en: "Pig"},
    {emoji: "üêî", es: "GALLINA", en: "Chicken"},
    {emoji: "üê¥", es: "CABALLO", en: "Horse"},
    {emoji: "üê∂", es: "PERRO", en: "Dog"},
    {emoji: "üê±", es: "GATO", en: "Cat"},
    {emoji: "üê∞", es: "CONEJO", en: "Rabbit"},
    {emoji: "ü¶ä", es: "ZORRO", en: "Fox"},
    {emoji: "üêª", es: "OSO", en: "Bear"},
    {emoji: "üêº", es: "PANDA", en: "Panda"},
    {emoji: "üê®", es: "KOALA", en: "Koala"},
    {emoji: "ü¶ò", es: "CANGURO", en: "Kangaroo"},
    {emoji: "üê¢", es: "TORTUGA", en: "Turtle"},
    {emoji: "üê∏", es: "RANA", en: "Frog"},
    {emoji: "üêß", es: "PING√úINO", en: "Penguin"},
    {emoji: "ü¶Ñ", es: "UNICORNIO", en: "Unicorn"},
    {emoji: "ü¶â", es: "B√öHO", en: "Owl"},
    {emoji: "ü¶ã", es: "MARIPOSA", en: "Butterfly"}
  ]
};

const NUMBERS_DATA = {
  numbers: [
    {num: 1, es: "UNO", en: "One"},
    {num: 2, es: "DOS", en: "Two"},
    {num: 3, es: "TRES", en: "Three"},
    {num: 4, es: "CUATRO", en: "Four"},
    {num: 5, es: "CINCO", en: "Five"},
    {num: 6, es: "SEIS", en: "Six"},
    {num: 7, es: "SIETE", en: "Seven"},
    {num: 8, es: "OCHO", en: "Eight"},
    {num: 9, es: "NUEVE", en: "Nine"},
    {num: 10, es: "DIEZ", en: "Ten"}
  ],
  countingObjects: ["üçé", "üåü", "üéà", "ü¶ã", "üå∏", "üç™", "‚öΩ", "üé®", "üìö", "üéÅ", "üöó", "üêï", "üå∫", "üçä", "üíé"]
};

// Extended countries data for Sofia's World
const COUNTRIES_DATA = [
  {flag: "üá™üá∏", country: "Espa√±a", countryEn: "Spain", capital: "Madrid", capitalEn: "Madrid", fact: "El flamenco es un arte espa√±ol"},
  {flag: "üá∑üá¥", country: "Ruman√≠a", countryEn: "Romania", capital: "Bucarest", capitalEn: "Bucharest", fact: "El castillo de Dr√°cula est√° en Ruman√≠a"},
  {flag: "üá´üá∑", country: "Francia", countryEn: "France", capital: "Par√≠s", capitalEn: "Paris", fact: "La Torre Eiffel tiene 330 metros"},
  {flag: "üáÆüáπ", country: "Italia", countryEn: "Italy", capital: "Roma", capitalEn: "Rome", fact: "La pizza naci√≥ en Italia"},
  {flag: "üá¨üáß", country: "Reino Unido", countryEn: "United Kingdom", capital: "Londres", capitalEn: "London", fact: "Big Ben es una campana gigante"},
  {flag: "üá©üá™", country: "Alemania", countryEn: "Germany", capital: "Berl√≠n", capitalEn: "Berlin", fact: "Los hermanos Grimm eran alemanes"},
  {flag: "üáµüáπ", country: "Portugal", countryEn: "Portugal", capital: "Lisboa", capitalEn: "Lisbon", fact: "El f√∫tbol es muy popular"},
  {flag: "üá≥üá±", country: "Pa√≠ses Bajos", countryEn: "Netherlands", capital: "√Åmsterdam", capitalEn: "Amsterdam", fact: "Los tulipanes son de all√≠"},
  {flag: "üáµüá±", country: "Polonia", countryEn: "Poland", capital: "Varsovia", capitalEn: "Warsaw", fact: "Chopin naci√≥ en Polonia"},
  {flag: "üá∫üá∏", country: "Estados Unidos", countryEn: "United States", capital: "Washington", capitalEn: "Washington", fact: "Disneyland est√° en California"},
  {flag: "üá≤üáΩ", country: "M√©xico", countryEn: "Mexico", capital: "Ciudad de M√©xico", capitalEn: "Mexico City", fact: "El chocolate viene de M√©xico"},
  {flag: "üá¶üá∑", country: "Argentina", countryEn: "Argentina", capital: "Buenos Aires", capitalEn: "Buenos Aires", fact: "El tango naci√≥ all√≠"},
  {flag: "üáßüá∑", country: "Brasil", countryEn: "Brazil", capital: "Brasilia", capitalEn: "Brasilia", fact: "El Amazonas es el r√≠o m√°s largo"},
  {flag: "üáØüáµ", country: "Jap√≥n", countryEn: "Japan", capital: "Tokio", capitalEn: "Tokyo", fact: "El sushi es comida japonesa"}
];

const COLORS_DATA = {
  objects: [
    {emoji: "üçé", name: "manzana", color: "rojo", colorEn: "Red", hex: "#ef4444"},
    {emoji: "üçå", name: "pl√°tano", color: "amarillo", colorEn: "Yellow", hex: "#fbbf24"},
    {emoji: "ü•í", name: "pepino", color: "verde", colorEn: "Green", hex: "#22c55e"},
    {emoji: "ü´ê", name: "ar√°ndano", color: "azul", colorEn: "Blue", hex: "#3b82f6"},
    {emoji: "üß°", name: "coraz√≥n", color: "naranja", colorEn: "Orange", hex: "#f97316"},
    {emoji: "üçá", name: "uva", color: "morado", colorEn: "Purple", hex: "#a855f7"},
    {emoji: "üå∏", name: "flor", color: "rosa", colorEn: "Pink", hex: "#ec4899"},
    {emoji: "‚òÅÔ∏è", name: "nube", color: "blanco", colorEn: "White", hex: "#f8fafc"},
    {emoji: "üåô", name: "luna", color: "amarillo", colorEn: "Yellow", hex: "#fbbf24"},
    {emoji: "üå≤", name: "√°rbol", color: "verde", colorEn: "Green", hex: "#22c55e"},
    {emoji: "üöó", name: "coche", color: "rojo", colorEn: "Red", hex: "#ef4444"},
    {emoji: "üåä", name: "mar", color: "azul", colorEn: "Blue", hex: "#3b82f6"},
    {emoji: "üß±", name: "ladrillo", color: "naranja", colorEn: "Orange", hex: "#f97316"},
    {emoji: "ü¶ã", name: "mariposa", color: "azul", colorEn: "Blue", hex: "#3b82f6"}, // Butterfly is BLUE
    {emoji: "üéÄ", name: "lazo", color: "rosa", colorEn: "Pink", hex: "#ec4899"},
    {emoji: "‚¨õ", name: "cuadro", color: "negro", colorEn: "Black", hex: "#1e293b"},
    {emoji: "üü§", name: "c√≠rculo", color: "marr√≥n", colorEn: "Brown", hex: "#a16207"},
    {emoji: "ü©∂", name: "piedra", color: "gris", colorEn: "Gray", hex: "#6b7280"}
  ],
  palette: [
    {name: "ROJO", en: "Red", hex: "#ef4444"},
    {name: "AMARILLO", en: "Yellow", hex: "#fbbf24"},
    {name: "VERDE", en: "Green", hex: "#22c55e"},
    {name: "AZUL", en: "Blue", hex: "#3b82f6"},
    {name: "NARANJA", en: "Orange", hex: "#f97316"},
    {name: "MORADO", en: "Purple", hex: "#a855f7"},
    {name: "ROSA", en: "Pink", hex: "#ec4899"},
    {name: "BLANCO", en: "White", hex: "#f8fafc"},
    {name: "NEGRO", en: "Black", hex: "#1e293b"},
    {name: "MARR√ìN", en: "Brown", hex: "#a16207"},
    {name: "GRIS", en: "Gray", hex: "#6b7280"}
  ]
};

const LEVELS_CONFIG = {
  zoo: [
    {type: "memory", pairs: 3, rounds: 3},
    {type: "memory", pairs: 4, rounds: 4},
    {type: "memory", pairs: 6, rounds: 6},
    {type: "memory", pairs: 4, rounds: 4},
    {type: "memory", pairs: 8, rounds: 8}
  ],
  numbers: [
    {type: "numbers", subType: "intro", targetNumbers: [1, 2, 3], rounds: 3},
    {type: "numbers", subType: "count", maxNum: 3, rounds: 4},
    {type: "numbers", subType: "select", maxNum: 5, rounds: 5},
    {type: "numbers", subType: "order", sequence: [1,2,3,4,5], rounds: 5},
    {type: "numbers", subType: "select", maxNum: 10, rounds: 6}
  ],
  sofia: [
    {type: "sofia", countries: 2, rounds: 2},
    {type: "sofia", countries: 3, rounds: 3},
    {type: "sofia", countries: 5, rounds: 5},
    {type: "sofia", countries: 7, rounds: 7},
    {type: "sofia", countries: 10, rounds: 10}
  ],
  colors: [
    {type: "identify", colors: ["rojo","amarillo","verde","azul"], rounds: 4},
    {type: "identify", colors: ["rojo","amarillo","verde","azul","naranja","morado"], rounds: 5},
    {type: "identify", colors: ["rojo","amarillo","verde","azul","naranja","morado","rosa","blanco"], rounds: 6},
    {type: "identify", colors: null, rounds: 6},
    {type: "identify", colors: null, rounds: 8}
  ]
};

// ============================================
// STATE MANAGEMENT
// ============================================
let currentLang = 'es';
let playerName = '';
let playerAvatar = 'üß∏';
let currentGame = '';
let currentLevel = 0;
let gameProgress = {};
let roundScore = 0;
let totalRounds = 0;
let learnedWords = [];
let sessionLearnedWords = new Set();
let flippedCards = [];
let lockBoard = false;
let numberIntroIndex = 0;
let countingAnswer = 0;
let countingTouched = [];
let orderSlots = [];
let orderItems = [];
let sofiaCountries = [];
let sofiaIndex = 0;
let currentColorItem = null;

// ============================================
// LANGUAGE SYSTEM
// ============================================
function setLanguage(lang) {
  currentLang = lang;
  localStorage.setItem('sofiaNoaLang', lang);
  
  document.querySelectorAll('.lang-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.lang === lang);
  });
  
  updateAllText();
}

function t(key) {
  const keys = key.split('.');
  let value = TRANSLATIONS[currentLang];
  for (const k of keys) {
    value = value?.[k];
  }
  return value || key;
}

function updateAllText() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.dataset.i18n;
    el.textContent = t(key);
  });
  
  document.getElementById('playerNameInput').placeholder = t('name_placeholder');
  
  if (currentGame) {
    renderLevelCards();
  }
  
  updateProgressDisplay();
}

// ============================================
// AVATAR SYSTEM
// ============================================
function selectAvatar(avatar) {
  playerAvatar = avatar;
  document.querySelectorAll('.avatar-option').forEach(opt => {
    opt.classList.toggle('selected', opt.dataset.avatar === avatar);
  });
  playSound('tap');
}

// ============================================
// AUDIO SYSTEM
// ============================================
let audioCtx = null;

function initAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state === 'suspended') {
    audioCtx.resume();
  }
}

function playSound(type) {
  initAudio();
  if (!audioCtx) return;
  const t = audioCtx.currentTime;
  
  if (type === 'tap') {
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    o.frequency.setValueAtTime(600, t);
    o.frequency.exponentialRampToValueAtTime(800, t + 0.08);
    g.gain.setValueAtTime(0.08, t);
    g.gain.linearRampToValueAtTime(0, t + 0.08);
    o.start(t); o.stop(t + 0.08);
  } else if (type === 'match' || type === 'success') {
    [523,659,783].forEach((f,i) => {
      const o = audioCtx.createOscillator(), g = audioCtx.createGain();
      o.type = 'sine'; o.connect(g); g.connect(audioCtx.destination);
      o.frequency.value = f;
      g.gain.setValueAtTime(0.06, t + i*0.1);
      g.gain.linearRampToValueAtTime(0, t + i*0.1 + 0.25);
      o.start(t + i*0.1); o.stop(t + i*0.1 + 0.25);
    });
  } else if (type === 'error') {
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    o.frequency.setValueAtTime(200, t);
    o.frequency.linearRampToValueAtTime(150, t + 0.15);
    g.gain.setValueAtTime(0.08, t);
    g.gain.linearRampToValueAtTime(0, t + 0.15);
    o.start(t); o.stop(t + 0.15);
  } else if (type === 'complete') {
    [523,659,783,880,1046].forEach((f,i) => {
      const o = audioCtx.createOscillator(), g = audioCtx.createGain();
      o.type = 'sine'; o.connect(g); g.connect(audioCtx.destination);
      o.frequency.value = f;
      g.gain.setValueAtTime(0.08, t + i*0.12);
      g.gain.linearRampToValueAtTime(0, t + i*0.12 + 0.35);
      o.start(t + i*0.12); o.stop(t + i*0.12 + 0.35);
    });
  }
}

function speakWord(word, lang = 'en-US') {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(word);
  utterance.lang = lang;
  utterance.rate = 0.8;
  utterance.pitch = 1.15;
  window.speechSynthesis.speak(utterance);
}

// ============================================
// NAVIGATION
// ============================================
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function startGame(e) {
  e.preventDefault();
  const input = document.getElementById('playerNameInput');
  const name = input.value.trim();
  if (name.length < 2) { input.focus(); return false; }
  playerName = name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();
  saveProgress();
  initMenu();
  showScreen('menu');
  playSound('match');
  return false;
}

function initMenu() {
  document.getElementById('playerNameDisplay').textContent = playerName;
  document.getElementById('menuMascot').textContent = playerAvatar;
  updateProgressDisplay();
  updateLevelDots();
}

function goToMenu() {
  playSound('tap');
  showScreen('menu');
  updateProgressDisplay();
  updateLevelDots();
}

function changeName() {
  playSound('tap');
  document.getElementById('playerNameInput').value = '';
  showScreen('welcome');
}

// ============================================
// PROGRESS SYSTEM
// ============================================
function loadProgress() {
  const saved = localStorage.getItem('sofiaNoaProgressV2');
  if (saved) {
    const data = JSON.parse(saved);
    gameProgress = data.progress || {};
    playerName = data.playerName || '';
    playerAvatar = data.playerAvatar || 'üß∏';
  }
  if (!gameProgress.zoo) gameProgress.zoo = [];
  if (!gameProgress.numbers) gameProgress.numbers = [];
  if (!gameProgress.sofia) gameProgress.sofia = [];
  if (!gameProgress.colors) gameProgress.colors = [];
  
  const savedLang = localStorage.getItem('sofiaNoaLang');
  if (savedLang && TRANSLATIONS[savedLang]) {
    currentLang = savedLang;
  }
}

function saveProgress() {
  localStorage.setItem('sofiaNoaProgressV2', JSON.stringify({
    playerName: playerName,
    playerAvatar: playerAvatar,
    progress: gameProgress
  }));
}

function updateProgressDisplay() {
  let totalLevels = 0;
  let completedLevels = 0;
  Object.keys(LEVELS_CONFIG).forEach(game => {
    totalLevels += LEVELS_CONFIG[game].length;
    completedLevels += gameProgress[game] ? gameProgress[game].length : 0;
  });
  const percent = totalLevels > 0 ? Math.round((completedLevels / totalLevels) * 100) : 0;
  document.getElementById('totalProgress').textContent = percent + '%';
  document.getElementById('progressFill').style.width = percent + '%';
  
  const totalCompleted = completedLevels;
  const levelText = totalCompleted < 5 ? t('beginner') :
                    totalCompleted < 10 ? t('explorer') :
                    totalCompleted < 15 ? t('adventurer') : t('master');
  document.getElementById('playerLevelDisplay').textContent = levelText;
  document.getElementById('playerStarsDisplay').textContent = '‚≠ê ' + totalCompleted;
}

function updateLevelDots() {
  Object.keys(LEVELS_CONFIG).forEach(game => {
    const container = document.getElementById(`${game}Levels`);
    if (!container) return;
    container.innerHTML = '';
    const totalLevels = LEVELS_CONFIG[game].length;
    const completed = gameProgress[game] ? gameProgress[game].length : 0;
    for (let i = 0; i < totalLevels; i++) {
      const dot = document.createElement('div');
      dot.className = 'level-dot';
      if (i < completed) dot.classList.add('completed');
      else if (i === completed) dot.classList.add('current');
      container.appendChild(dot);
    }
  });
}

function resetProgress() {
  if (confirm(currentLang === 'es' ? 'Esto borrar√° todo tu progreso. ¬øEst√°s seguro?' :
              currentLang === 'en' ? 'This will erase all progress. Are you sure?' :
              'Aceasta va »ôterge tot progresul. E»ôti sigur?')) {
    gameProgress = { zoo: [], numbers: [], sofia: [], colors: [] };
    sessionLearnedWords = new Set();
    saveProgress();
    updateProgressDisplay();
    updateLevelDots();
    playSound('tap');
  }
}

// ============================================
// GAME SELECT
// ============================================
function openGameSelect(game) {
  playSound('tap');
  currentGame = game;
  const icons = {zoo:'ü¶Å', numbers:'üî¢', sofia:'‚úàÔ∏è', colors:'üé®'};
  document.getElementById('gameSelectIcon').textContent = icons[game];
  document.getElementById('gameSelectTitle').textContent = t(`game_${game}`);
  renderLevelCards();
  showScreen('game-select');
}

function renderLevelCards() {
  const container = document.getElementById('levelsGrid');
  container.innerHTML = '';
  const levels = t('levels')[currentGame];
  const completed = gameProgress[currentGame] ? gameProgress[currentGame].length : 0;
  
  levels.forEach((level, index) => {
    const isCompleted = index < completed;
    const isCurrent = index === completed;
    const isLocked = index > completed;
    
    const card = document.createElement('div');
    card.className = 'level-card';
    if (isCompleted) card.classList.add('completed');
    else if (isCurrent) card.classList.add('current');
    else card.classList.add('locked');
    
    card.innerHTML = `
      <div class="level-number">${isCompleted ? '‚úì' : index + 1}</div>
      <div class="level-info">
        <div class="level-name">${level.name}</div>
        <div class="level-desc">${level.desc}</div>
      </div>
      <div class="level-status">${isCompleted ? '‚≠ê' : isCurrent ? '‚ñ∂' : 'üîí'}</div>
    `;
    
    if (!isLocked) {
      card.onclick = () => startLevel(index);
    }
    container.appendChild(card);
  });
}

// ============================================
// GAME INITIALIZATION
// ============================================
function startLevel(levelIndex) {
  playSound('tap');
  currentLevel = levelIndex;
  roundScore = 0;
  learnedWords = [];
  flippedCards = [];
  lockBoard = false;
  numberIntroIndex = 0;
  
  document.getElementById('levelBadge').textContent = t('level') + ' ' + (levelIndex + 1);
  document.getElementById('instructionPlayerName').textContent = playerName;
  
  const levelData = t('levels')[currentGame][currentLevel];
  document.getElementById('instructionText').textContent = levelData.instruction;
  
  document.querySelectorAll('.game-area').forEach(a => a.classList.remove('active'));
  
  const config = LEVELS_CONFIG[currentGame][currentLevel];
  totalRounds = config.rounds;
  
  initProgressStars();
  showScreen('game');
  
  setTimeout(() => {
    const config = LEVELS_CONFIG[currentGame][currentLevel];
    switch (config.type) {
      case 'memory': startMemoryGame(); break;
      case 'numbers': startNumbersGame(); break;
      case 'sofia': startSofiaGame(); break;
      case 'identify': startColorsGame(); break;
    }
  }, 300);
}

function initProgressStars() {
  const container = document.getElementById('progressStars');
  container.innerHTML = '';
  for (let i = 0; i < totalRounds; i++) {
    const star = document.createElement('div');
    star.className = 'progress-star';
    star.textContent = '‚≠ê';
    container.appendChild(star);
  }
}

function addProgressStar() {
  const stars = document.querySelectorAll('#progressStars .progress-star');
  if (stars[roundScore]) {
    stars[roundScore].classList.add('earned');
  }
  roundScore++;
  if (roundScore >= totalRounds) {
    setTimeout(completeLevel, 800);
  }
}

function canShowWord(word) {
  return !sessionLearnedWords.has(word.toLowerCase());
}

function markWordLearned(word) {
  sessionLearnedWords.add(word.toLowerCase());
}

// ============================================
// MEMORY GAME (ZOO)
// ============================================
function startMemoryGame() {
  document.getElementById('memoryArea').classList.add('active');
  const config = LEVELS_CONFIG[currentGame][currentLevel];
  const pairs = config.pairs;
  
  const availableAnimals = ZOO_DATA.animals.filter(a => canShowWord(a.es));
  const items = (availableAnimals.length >= pairs ? availableAnimals : ZOO_DATA.animals)
    .sort(() => Math.random() - 0.5)
    .slice(0, pairs);
  
  const deck = [...items, ...items].sort(() => Math.random() - 0.5);
  const grid = document.getElementById('memoryGrid');
  grid.innerHTML = '';
  flippedCards = [];
  lockBoard = false;
  
  const cols = pairs <= 3 ? 3 : 4;
  grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
  
  deck.forEach((item, index) => {
    const card = document.createElement('div');
    card.className = 'memory-card';
    card.dataset.index = index;
    card.dataset.emoji = item.emoji;
    card.dataset.es = item.es;
    card.dataset.en = item.en;
    card.innerHTML = `
      <div class="card-face card-front"></div>
      <div class="card-face card-back">${item.emoji}</div>
    `;
    card.onclick = () => flipCard(card);
    grid.appendChild(card);
  });
}

function flipCard(card) {
  if (lockBoard || card.classList.contains('flipped')) return;
  playSound('tap');
  card.classList.add('flipped');
  flippedCards.push(card);
  
  if (flippedCards.length === 2) {
    lockBoard = true;
    const [first, second] = flippedCards;
    
    if (first.dataset.emoji === second.dataset.emoji) {
      playSound('match');
      first.classList.add('matched');
      second.classList.add('matched');
      
      showVocabPopup(first.dataset.emoji, first.dataset.es, first.dataset.en);
      speakWord(first.dataset.en);
      
      if (canShowWord(first.dataset.es)) {
        markWordLearned(first.dataset.es);
        learnedWords.push({emoji: first.dataset.emoji, es: first.dataset.es, en: first.dataset.en});
      }
      
      flippedCards = [];
      lockBoard = false;
      addProgressStar();
    } else {
      setTimeout(() => {
        playSound('error');
        first.classList.remove('flipped');
        second.classList.remove('flipped');
        flippedCards = [];
        lockBoard = false;
      }, 800);
    }
  }
}

// ============================================
// NUMBERS GAME
// ============================================
function startNumbersGame() {
  document.getElementById('numbersArea').classList.add('active');
  const config = LEVELS_CONFIG[currentGame][currentLevel];
  
  switch (config.subType) {
    case 'intro': initNumberIntro(); break;
    case 'count': initNumberCount(); break;
    case 'select': initNumberSelect(); break;
    case 'order': initNumberOrder(); break;
  }
}

function initNumberIntro() {
  const config = LEVELS_CONFIG[currentGame][currentLevel];
  const targets = config.targetNumbers || [1, 2, 3];
  const num = targets[numberIntroIndex] || targets[0];
  const objEmoji = NUMBERS_DATA.countingObjects[Math.floor(Math.random() * NUMBERS_DATA.countingObjects.length)];
  
  const container = document.getElementById('numbersContainer');
  container.innerHTML = `
    <div class="number-intro-card" onclick="handleNumberIntroClick()">
      <div class="number-big">${num}</div>
      <div class="number-objects">
        ${Array(num).fill(objEmoji).map(e => `<span class="number-object">${e}</span>`).join('')}
      </div>
      <div class="number-prompt">${t('number_prompt')}</div>
    </div>
  `;
}

function handleNumberIntroClick() {
  const config = LEVELS_CONFIG[currentGame][currentLevel];
  const targets = config.targetNumbers || [1, 2, 3];
  const num = targets[numberIntroIndex];
  const numData = NUMBERS_DATA.numbers.find(n => n.num === num);
  
  playSound('success');
  showVocabPopup(num.toString(), numData.es, numData.en);
  speakWord(numData.en);
  
  if (canShowWord(numData.es)) {
    markWordLearned(numData.es);
    learnedWords.push({emoji: num.toString(), es: numData.es, en: numData.en});
  }
  
  addProgressStar();
  numberIntroIndex++;
  
  if (numberIntroIndex < targets.length) {
    setTimeout(initNumberIntro, 1500);
  }
}

function initNumberCount() {
  const config = LEVELS_CONFIG[currentGame][currentLevel];
  const maxNum = config.maxNum || 3;
  const count = Math.floor(Math.random() * maxNum) + 1;
  const objEmoji = NUMBERS_DATA.countingObjects[Math.floor(Math.random() * NUMBERS_DATA.countingObjects.length)];
  
  countingAnswer = count;
  countingTouched = Array(count).fill(false);
  
  const container = document.getElementById('numbersContainer');
  container.innerHTML = `
    <div class="counting-objects" id="countingObjectsArea">
      ${Array(count).fill(0).map((_, i) => 
        `<div class="counting-item" data-index="${i}" onclick="handleCountingTouch(${i})">${objEmoji}</div>`
      ).join('')}
    </div>
    <div class="counting-prompt">${t('counting_prompt')}</div>
  `;
}

function handleCountingTouch(index) {
  if (countingTouched[index]) return;
  
  playSound('tap');
  countingTouched[index] = true;
  
  const item = document.querySelector(`.counting-item[data-index="${index}"]`);
  if (item) item.classList.add('touched');
  
  const currentCount = countingTouched.filter(Boolean).length;
  const numData = NUMBERS_DATA.numbers.find(n => n.num === currentCount);
  if (numData) speakWord(numData.en);
  
  if (countingTouched.every(Boolean)) {
    setTimeout(() => {
      playSound('success');
      const answerNum = NUMBERS_DATA.numbers.find(n => n.num === countingAnswer);
      showVocabPopup(countingAnswer.toString(), answerNum.es, answerNum.en);
      if (canShowWord(answerNum.es)) {
        markWordLearned(answerNum.es);
        learnedWords.push({emoji: countingAnswer.toString(), es: answerNum.es, en: answerNum.en});
      }
      addProgressStar();
      
      if (roundScore < totalRounds) {
        setTimeout(initNumberCount, 1200);
      }
    }, 500);
  }
}

function initNumberSelect() {
  const config = LEVELS_CONFIG[currentGame][currentLevel];
  const maxNum = config.maxNum || 5;
  const count = Math.floor(Math.random() * maxNum) + 1;
  const objEmoji = NUMBERS_DATA.countingObjects[Math.floor(Math.random() * NUMBERS_DATA.countingObjects.length)];
  
  countingAnswer = count;
  
  const options = new Set([count]);
  while (options.size < Math.min(4, maxNum)) {
    options.add(Math.floor(Math.random() * maxNum) + 1);
  }
  const optionsArray = Array.from(options).sort(() => Math.random() - 0.5);
  
  const container = document.getElementById('numbersContainer');
  container.innerHTML = `
    <div class="counting-display">
      ${Array(count).fill(objEmoji).map(e => `<span class="counting-display-item">${e}</span>`).join('')}
    </div>
    <div class="counting-question">${t('counting_question')}</div>
    <div class="counting-options">
      ${optionsArray.map(n => 
        `<div class="count-option" data-num="${n}" onclick="handleNumberSelect(${n})">${n}</div>`
      ).join('')}
    </div>
  `;
}

function handleNumberSelect(num) {
  const selected = document.querySelector(`.count-option[data-num="${num}"]`);
  
  if (num === countingAnswer) {
    playSound('success');
    selected.classList.add('correct');
    
    const numData = NUMBERS_DATA.numbers.find(n => n.num === num);
    showVocabPopup(num.toString(), numData.es, numData.en);
    speakWord(numData.en);
    
    if (canShowWord(numData.es)) {
      markWordLearned(numData.es);
      learnedWords.push({emoji: num.toString(), es: numData.es, en: numData.en});
    }
    
    addProgressStar();
    
    if (roundScore < totalRounds) {
      setTimeout(initNumberSelect, 1200);
    }
  } else {
    playSound('error');
    selected.classList.add('wrong');
    setTimeout(() => selected.classList.remove('wrong'), 400);
  }
}

function initNumberOrder() {
  const config = LEVELS_CONFIG[currentGame][currentLevel];
  const sequence = config.sequence || [1, 2, 3, 4, 5];
  
  orderSlots = Array(sequence.length).fill(null);
  orderItems = [...sequence].sort(() => Math.random() - 0.5);
  
  const container = document.getElementById('numbersContainer');
  container.innerHTML = `
    <div class="order-slots" id="orderSlotsArea">
      ${sequence.map((num, i) => 
        `<div class="order-slot" data-slot="${i}">${num}</div>`
      ).join('')}
    </div>
    <div class="order-items" id="orderItemsArea">
      ${orderItems.map((num, i) => 
        `<div class="order-item" data-num="${num}" data-index="${i}" onclick="handleOrderItem(${num}, ${i})">${num}</div>`
      ).join('')}
    </div>
  `;
}

function handleOrderItem(num, index) {
  const config = LEVELS_CONFIG[currentGame][currentLevel];
  const sequence = config.sequence || [1, 2, 3, 4, 5];
  const firstEmptySlot = orderSlots.findIndex(s => s === null);
  
  if (firstEmptySlot === -1) return;
  
  if (num === sequence[firstEmptySlot]) {
    playSound('success');
    orderSlots[firstEmptySlot] = num;
    
    const slot = document.querySelectorAll('.order-slot')[firstEmptySlot];
    slot.classList.add('filled');
    slot.textContent = num;
    
    const item = document.querySelector(`.order-item[data-num="${num}"][data-index="${index}"]`);
    if (item) item.classList.add('used');
    
    const numData = NUMBERS_DATA.numbers.find(n => n.num === num);
    if (canShowWord(numData.es)) {
      markWordLearned(numData.es);
      learnedWords.push({emoji: num.toString(), es: numData.es, en: numData.en});
    }
    
    addProgressStar();
    
    if (orderSlots.every(s => s !== null)) {
      speakWord("Perfect!");
    }
  } else {
    playSound('error');
  }
}

// ============================================
// SOFIA GAME - ENHANCED
// ============================================
function startSofiaGame() {
  document.getElementById('sofiaArea').classList.add('active');
  const config = LEVELS_CONFIG[currentGame][currentLevel];
  const numCountries = config.countries || 2;
  
  const availableCountries = COUNTRIES_DATA.filter(c => canShowWord(c.country));
  sofiaCountries = (availableCountries.length >= numCountries ? availableCountries : COUNTRIES_DATA)
    .sort(() => Math.random() - 0.5)
    .slice(0, numCountries);
  
  sofiaIndex = 0;
  renderSofiaCountry();
}

function renderSofiaCountry() {
  const country = sofiaCountries[sofiaIndex];
  if (!country) return;
  
  const otherCapitals = COUNTRIES_DATA
    .filter(c => c.capital !== country.capital)
    .map(c => c.capital)
    .sort(() => Math.random() - 0.5)
    .slice(0, 2);
  const capitalOptions = [country.capital, ...otherCapitals].sort(() => Math.random() - 0.5);
  
  const container = document.getElementById('sofiaContainer');
  container.innerHTML = `
    <div class="sofia-plane">‚úàÔ∏è</div>
    <div class="sofia-country-card">
      <div class="sofia-flag">${country.flag}</div>
      <div class="sofia-country-name">${country.country}</div>
      <div class="sofia-question">${t('sofia_question')}</div>
    </div>
    <div class="sofia-capitals" id="sofiaCapitals">
      ${capitalOptions.map(cap => 
        `<button class="capital-btn" data-capital="${cap}" onclick="handleCapitalSelect('${cap}')">${cap}</button>`
      ).join('')}
    </div>
  `;
}

function handleCapitalSelect(selectedCapital) {
  const country = sofiaCountries[sofiaIndex];
  
  if (selectedCapital === country.capital) {
    playSound('success');
    
    // Mark button as correct
    const btn = document.querySelector(`.capital-btn[data-capital="${selectedCapital}"]`);
    if (btn) btn.classList.add('correct');
    
    // Build popup content with fact
    const factText = country.fact ? `\nüí° ${country.fact}` : '';
    showVocabPopup(country.flag, `${country.country} - ${country.capital}`, country.countryEn);
    speakWord(country.countryEn);
    
    if (canShowWord(country.country)) {
      markWordLearned(country.country);
      learnedWords.push({emoji: country.flag, es: country.country, en: country.countryEn});
    }
    if (canShowWord(country.capital)) {
      markWordLearned(country.capital);
      learnedWords.push({emoji: country.flag, es: country.capital, en: country.capitalEn});
    }
    
    // Show fun fact
    if (country.fact) {
      const container = document.getElementById('sofiaContainer');
      const factDiv = document.createElement('div');
      factDiv.className = 'sofia-fact';
      factDiv.textContent = `üí° ${country.fact}`;
      container.appendChild(factDiv);
    }
    
    addProgressStar();
    
    sofiaIndex++;
    if (sofiaIndex < sofiaCountries.length) {
      setTimeout(renderSofiaCountry, 2000);
    }
  } else {
    playSound('error');
  }
}

// ============================================
// COLORS GAME - FIXED BUTTERFLY
// ============================================
function startColorsGame() {
  document.getElementById('colorsArea').classList.add('active');
  nextColorRound();
}

function nextColorRound() {
  const config = LEVELS_CONFIG[currentGame][currentLevel];
  
  let objects = [...COLORS_DATA.objects];
  if (config.colors) {
    objects = objects.filter(o => config.colors.includes(o.color));
  }
  
  const availableObjects = objects.filter(o => canShowWord(o.color));
  currentColorItem = (availableObjects.length > 0 ? availableObjects : objects)
    .sort(() => Math.random() - 0.5)[0];
  
  const correctColor = COLORS_DATA.palette.find(c => c.hex === currentColorItem.hex);
  const otherColors = COLORS_DATA.palette
    .filter(c => c.hex !== currentColorItem.hex)
    .sort(() => Math.random() - 0.5)
    .slice(0, 4);
  const colorButtons = [correctColor, ...otherColors].filter(Boolean).sort(() => Math.random() - 0.5);
  
  const container = document.getElementById('colorsContainer');
  container.innerHTML = `
    <div class="color-target">
      <span class="target-emoji">${currentColorItem.emoji}</span>
      <span class="target-question">${t('color_question')} <span class="target-word">la ${currentColorItem.name}</span>?</span>
    </div>
    <div class="color-palette">
      ${colorButtons.map(c => 
        `<div class="color-btn" style="background-color: ${c.hex}; border-color: ${c.hex === '#f8fafc' ? '#e2e8f0' : 'white'};" data-hex="${c.hex}" onclick="handleColorSelect('${c.hex}')"></div>`
      ).join('')}
    </div>
  `;
}

function handleColorSelect(hex) {
  if (hex === currentColorItem.hex) {
    playSound('success');
    showVocabPopup(currentColorItem.emoji, currentColorItem.color.toUpperCase(), currentColorItem.colorEn);
    speakWord(currentColorItem.colorEn);
    
    if (canShowWord(currentColorItem.color)) {
      markWordLearned(currentColorItem.color);
      learnedWords.push({emoji: currentColorItem.emoji, es: currentColorItem.color.toUpperCase(), en: currentColorItem.colorEn});
    }
    
    addProgressStar();
    
    if (roundScore < totalRounds) {
      setTimeout(nextColorRound, 1200);
    }
  } else {
    playSound('error');
  }
}

// ============================================
// VOCABULARY POPUP
// ============================================
function showVocabPopup(emoji, es, en) {
  const popup = document.getElementById('vocabPopup');
  document.getElementById('vocabEmoji').textContent = emoji;
  document.getElementById('vocabWord').textContent = es;
  document.getElementById('vocabTranslation').textContent = en;
  popup.classList.add('show');
  setTimeout(() => popup.classList.remove('show'), 2000);
}

// ============================================
// LEVEL COMPLETION
// ============================================
function completeLevel() {
  playSound('complete');
  
  if (!gameProgress[currentGame]) gameProgress[currentGame] = [];
  if (!gameProgress[currentGame].includes(currentLevel)) {
    gameProgress[currentGame].push(currentLevel);
    saveProgress();
  }
  
  document.getElementById('completeMascot').textContent = playerAvatar;
  document.getElementById('completeTitle').textContent = 
    (currentLang === 'es' ? `¬°Lo lograste, ${playerName}!` :
     currentLang === 'en' ? `You did it, ${playerName}!` :
     `Ai reu»ôit, ${playerName}!`);
  
  const levelData = t('levels')[currentGame][currentLevel];
  document.getElementById('completeSubtitle').textContent = `${t('complete_achievement')} "${levelData.name}"`;
  
  const starsContainer = document.getElementById('completeStars');
  starsContainer.innerHTML = '';
  for (let i = 0; i < 3; i++) {
    const star = document.createElement('span');
    star.className = 'complete-star earned';
    star.textContent = '‚≠ê';
    starsContainer.appendChild(star);
  }
  
  const wordsGrid = document.getElementById('wordsGrid');
  wordsGrid.innerHTML = '';
  learnedWords.slice(0, 6).forEach(word => {
    const chip = document.createElement('div');
    chip.className = 'word-chip';
    chip.innerHTML = `
      <span class="word-emoji">${word.emoji}</span>
      <span class="word-es">${word.es}</span>
      <span class="word-en">${word.en}</span>
    `;
    wordsGrid.appendChild(chip);
  });
  
  const nextBtn = document.getElementById('nextLevelBtn');
  const hasNextLevel = currentLevel < LEVELS_CONFIG[currentGame].length - 1;
  nextBtn.style.display = hasNextLevel ? 'flex' : 'none';
  
  showScreen('level-complete');
  launchConfetti();
}

function nextLevel() {
  playSound('tap');
  if (currentLevel < LEVELS_CONFIG[currentGame].length - 1) {
    currentLevel++;
    startLevel(currentLevel);
  } else {
    goToMenu();
  }
}

function exitGame() {
  playSound('tap');
  showScreen('game-select');
}

// ============================================
// CONFETTI
// ============================================
function launchConfetti() {
  const container = document.getElementById('confettiContainer');
  container.innerHTML = '';
  const colors = ['#6366f1', '#f97316', '#22c55e', '#fbbf24', '#ec4899', '#3b82f6', '#a855f7'];
  for (let i = 0; i < 80; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.left = Math.random() * 100 + '%';
    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
    confetti.style.animationDelay = Math.random() * 0.5 + 's';
    confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '3px';
    confetti.style.width = (Math.random() * 8 + 8) + 'px';
    confetti.style.height = (Math.random() * 8 + 8) + 'px';
    container.appendChild(confetti);
  }
  setTimeout(() => container.innerHTML = '', 4000);
}

// ============================================
// INITIALIZATION
// ============================================
document.addEventListener('DOMContentLoaded', function() {
  loadProgress();
  
  // Set language buttons
  document.querySelectorAll('.lang-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.lang === currentLang);
  });
  
  // Set avatar selection
  if (playerAvatar) {
    document.querySelectorAll('.avatar-option').forEach(opt => {
      opt.classList.toggle('selected', opt.dataset.avatar === playerAvatar);
    });
  }
  
  if (playerName) {
    document.getElementById('playerNameInput').value = playerName;
    initMenu();
    showScreen('menu');
  }
  
  updateAllText();
  
  document.getElementById('playerNameInput').addEventListener('input', function() {
    document.getElementById('startBtn').disabled = this.value.trim().length < 2;
  });
  
  // Prevent double-tap zoom
  let lastTouchEnd = 0;
  document.addEventListener('touchend', function(e) {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
      e.preventDefault();
    }
    lastTouchEnd = now;
  }, { passive: false });
});
</script>
</body>
</html>
